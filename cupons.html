<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>שם זה זול יותר</title>
  <script defer data-domain="yossidisk.github.io/shamze/cupons.html" src="https://plausible.io/js/script.js"></script>


  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
      color: #333;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 24px;
    }

    h4 {
      margin-bottom: 20px;
      color: #7f8c8d;
      font-size: 14px;
      font-weight: normal;
    }

    .search-container {
      position: relative;
      max-width: 300px;
      margin: 0 auto;
    }

    .search-input {
      padding: 12px 30px 12px 12px;
      font-size: 16px;
      border: 1px solid #999;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .search-container {
      position: relative;
      max-width: 300px;
      margin: 0 auto;
      width: 100%;
    }

    .search-input:focus {
      outline: none;
      border-color: #555;
    }

    .clear-search {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      font-size: 18px;
    }

    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }

    .coupon-button,
    .compare-button {
      padding: 15px;
      background-color: #777;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 300px;
    }

    .coupon-button:hover,
    .coupon-button:active,
    .compare-button:hover,
    .compare-button:active {
      background-color: #555;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .loading-container {
      text-align: center;
      margin: 20px 0;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    .request-coupon-button {
      background-color: #3498db;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .email-input {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      max-width: 300px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .product {
      border: 1px solid #ddd;
      padding: 15px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      margin-bottom: 15px;
      text-align: right;
      width: 100%;
      max-width: 300px;
      overflow: hidden;
    }

    .product h3 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .product h3:hover {
      text-decoration: underline;
    }

    .product p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }

    .comparison-result {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-item {
      width: calc(50% - 10px);
      margin-bottom: 20px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: right;
    }

    .comparison-item h3 {
      margin-top: 0;
      font-size: 16px;
      color: #333;
    }

    .comparison-item p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    .coupon-details {
      margin-top: 10px;
    }

    .coupon-toggle {
      background-color: #f0f0f0;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .coupon-toggle:after {
      content: '▼';
      font-size: 12px;
      margin-right: 5px;
      transition: transform 0.3s ease;
    }

    .coupon-toggle.active:after {
      transform: rotate(180deg);
    }

    .coupon-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .coupon-content.active {
      max-height: 500px;
      /* adjust as needed */
    }

    .copy-icon {
      cursor: pointer;
      margin-right: 10px;
    }

    .site-link {
      color: #3498db;
      text-decoration: none;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }

    .site-link:hover {
      text-decoration: underline;
    }

    .coupon-info {
      font-size: 12px;
      color: #777;
      margin-top: 5px;
    }

    .popular-searches-container {
      margin-top: 20px;
      text-align: center;
    }

    .popular-search-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .popular-search-button {
      padding: 10px 15px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .popular-search-button:hover {
      background-color: #e0e0e0;
    }

    @media (max-width: 600px) {
      .comparison-item {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <h1>שם זה זול יותר</h1>
  <h4>חפש לפי חנות או שם מוצר</h4>

  <div class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder='לדוגמא "המשביר" או "אוזניות גיימינג"'>
    <span id="clearSearch" class="clear-search">✕</span>
  </div>

  <div id="loadingContainer" class="loading-container" style="display: none;">
    <div class="loading-spinner"></div>
    <p>מחפש מוצרים...</p>
  </div>

  <div id="sortContainer" class="sort-container" style="display: none;">
    <select id="sortSelect" class="sort-select">
      <option value="default">מיון לפי</option>
      <option value="price-asc">מחיר: מהנמוך לגבוה</option>
      <option value="price-desc">מחיר: מהגבוה לנמוך</option>
    </select>
  </div>

  <div id="resultsContainer" class="button-container"></div>

  <div id="compareButtonContainer" style="display: none;">
    <button id="compareButton" class="compare-button"></button>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const loadingContainer = document.getElementById('loadingContainer');
    const compareButtonContainer = document.getElementById('compareButtonContainer');
    const compareButton = document.getElementById('compareButton');
    const resultsContainer = document.getElementById('resultsContainer');

    let currentSearchQuery = '';
    let allSites = [];

    // Fetch all sites data
    fetch("https://o0rmue7xt0.execute-api.il-central-1.amazonaws.com/dev/sites")
      .then(response => response.json())
      .then(data => {
        allSites = data;
      })
      .catch(error => console.error("Error fetching sites:", error));

    function showLoading() {
      loadingContainer.style.display = 'block';
    }

    function hideLoading() {
      loadingContainer.style.display = 'none';
    }

    function updateCompareButton(query) {
      if (query.trim()) {
        compareButton.textContent = `השוואת מחירים עבור "${query}"`;
        compareButtonContainer.style.display = 'block';
      } else {
        compareButtonContainer.style.display = 'none';
      }
    }

    let searchedUrl = '';

    function search(query) {
      currentSearchQuery = query;
      showLoading();
      resultsContainer.innerHTML = '';

      if (query.trim() === '') {
        hideLoading();
        displayPopularSearches();
        sortContainer.style.display = 'none';
        return;
      }

      sortContainer.style.display = 'none';

      // Check if the query is a URL
      if (query.toLowerCase().startsWith('https://')) {
        searchedUrl = query; // Store the searched URL
        searchByUrl(query);
      } else {
        searchedUrl = ''; // Reset the searched URL
        const filteredSites = allSites.filter(site =>
          site.siteName.toLowerCase().includes(query.toLowerCase()) ||
          (site.cuponDetails && site.cuponDetails.toLowerCase().includes(query.toLowerCase()))
        );

        hideLoading();
        displaySearchResults(filteredSites);
        updateCompareButton(query);
      }

      // Plausible analytics
      plausible('Search', { props: { query: query } });
    }

    function searchByUrl(url) {
      const matchingSite = allSites.find(site => url.toLowerCase().startsWith(site.URL.toLowerCase()));
      
      if (matchingSite) {
        displaySearchResults([matchingSite], true); // Pass true to indicate URL search
        updateCompareButton(matchingSite.siteName);
      } else {
        displayNoCouponMessage(url);
      }
      
      hideLoading();
    }

    function displayNoCouponMessage(url) {
      const siteName = new URL(url).hostname;
      resultsContainer.innerHTML = `
        <p>נראה שאין כאן קופון, אפשר ללחוץ כאן ולבקש להוסיף</p>
        <button class="request-coupon-button" onclick="requestCoupon('${siteName}')">בקשת הטבה ל${siteName}</button>
      `;
    }

    function requestCoupon(siteName) {
      const emailInput = document.createElement('input');
      emailInput.type = 'email';
      emailInput.placeholder = 'הזן את כתובת המייל שלך';
      emailInput.className = 'email-input';

      const submitButton = document.createElement('button');
      submitButton.textContent = 'שליחה';
      submitButton.className = 'request-coupon-button';
      submitButton.onclick = function() {
        const email = emailInput.value;
        if (email) {
          // Plausible analytics
          plausible('CouponRequest', { 
            props: { 
              site: siteName,
              email: email
            }
          });
          alert('הבקשה נשלחה');
          emailInput.remove();
          submitButton.remove();
        } else {
          alert('אנא הזן כתובת מייל תקינה');
        }
      };

      resultsContainer.appendChild(emailInput);
      resultsContainer.appendChild(submitButton);
    }

    function displayPopularSearches() {
      const popularSearches = [
        "Ali express",
        "Golf",
        "המשביר",
        "ACE",
        "איירפודס",
        "NAUTICA",
        "בושם לגבר",
        "Toys R us"
      ];

      const container = document.createElement('div');
      container.className = 'popular-searches-container';

      const title = document.createElement('h3');
      title.textContent = 'חיפושים נפוצים';
      container.appendChild(title);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'popular-search-buttons';

      popularSearches.forEach(searchQuery => {
        const button = document.createElement('button');
        button.textContent = searchQuery;
        button.className = 'popular-search-button';
        button.addEventListener('click', () => {
          const searchInput = document.querySelector('#searchInput');
          searchInput.value = searchQuery;

          // דיווח ל-Plausible
          if (window.plausible) {
            window.plausible('PopularSearch', { props: { query: searchQuery } });
          }

          handleSearchInput();
        });
        buttonContainer.appendChild(button);
      });

      container.appendChild(buttonContainer);
      resultsContainer.appendChild(container);
    }

    function initializeSearch() {
      const searchInput = document.querySelector('#searchInput');
      const clearSearchSpan = document.querySelector('#clearSearch');

      // הצג חיפושים נפוצים בטעינה הראשונית אם שדה החיפוש ריק
      if (searchInput.value.trim() === '') {
        displayPopularSearches();
      } else {
        search(searchInput.value);
      }

      // האזנה לשינויים בשדה החיפוש
      searchInput.addEventListener('input', handleSearchInput);

      // טיפול באלמנט הניקוי
      if (clearSearchSpan) {
        clearSearchSpan.addEventListener('click', function () {
          searchInput.value = '';
          handleSearchInput();
          // הסתרת אלמנט הניקוי אם צריך
          this.style.display = 'none';
        });
      }

      // האזנה לאירוע 'submit' של הטופס (אם קיים)
      const searchForm = document.querySelector('form');
      if (searchForm) {
        searchForm.addEventListener('submit', function (e) {
          e.preventDefault();
          search(searchInput.value);
        });
      }
    }

    function handleSearchInput() {
      const searchInput = document.querySelector('#searchInput');
      const clearSearchSpan = document.querySelector('#clearSearch');

      if (searchInput.value.trim() === '') {
        displayPopularSearches();
        // הסתרת אלמנט הניקוי כשהשדה ריק
        if (clearSearchSpan) clearSearchSpan.style.display = 'none';
      } else {
        search(searchInput.value);
        // הצגת אלמנט הניקוי כשיש טקסט בשדה
        if (clearSearchSpan) clearSearchSpan.style.display = 'inline';
      }
    }

    // הפעלת פונקציית האתחול כאשר הדף נטען
    document.addEventListener('DOMContentLoaded', initializeSearch);


    function displaySearchResults(results, isUrlSearch = false) {
      resultsContainer.innerHTML = '';

      // יצירת Map לאחסון תוצאה אחת לכל siteName
      const uniqueResults = new Map();

      // סינון התוצאות כדי לשמור רק תוצאה אחת לכל siteName
      results.forEach(site => {
        if (!uniqueResults.has(site.siteName)) {
          uniqueResults.set(site.siteName, site);
        }
      });

      // הצגת התוצאות הייחודיות
      uniqueResults.forEach(site => {
        const siteDiv = document.createElement('div');
        siteDiv.className = 'product';

        let siteContent = `<h3>${site.siteName}</h3>`;

        if (site.cupon && site.cupon !== "") {
          siteContent += `
        <div class="coupon-details">
            <button class="coupon-toggle">פרטי קופון</button>
            <div class="coupon-content">
                <span>${site.cupon}</span>
                <span class="copy-icon" onclick="copyCoupon('${site.cupon}', event)">📋</span>
                <a href="#" class="site-link" onclick="goToSite('${site.affLink || site.URL}', '${site.siteName}', '${isUrlSearch ? 'למוצר' : 'לאתר'}', event)">
                  עבור ${isUrlSearch ? 'למוצר' : 'לאתר'}
                </a>
                <p class="coupon-info">${site.cuponDetails || ''}</p>
            </div>
        </div>
      `;
        } else {
          siteContent += `<a href="#" class="site-link" onclick="goToSite('${site.affLink || site.URL}', '${site.siteName}', '${isUrlSearch ? 'למוצר' : 'לאתר'}', event)">
            עבור ${isUrlSearch ? 'למוצר' : 'לאתר'}
          </a>`;
        }

        siteDiv.innerHTML = siteContent;

        // הוספת מאזין אירועים לכותרת
        siteDiv.querySelector('h3').addEventListener('click', (event) => {
          goToSite(site.affLink || site.URL, site.siteName, isUrlSearch ? 'למוצר' : 'לאתר', event);
        });

        siteDiv.querySelector('.coupon-toggle')?.addEventListener('click', toggleCoupon);
        resultsContainer.appendChild(siteDiv);
      });
    }


    function logClick(site) {
      if (window.plausible) {
        window.plausible('SiteClick', {
          props: {
            productName: site.siteName,
            targetSite: site.siteName,
            searchQuery: currentSearchQuery // וודא שזה מוגדר במקום המתאים בקוד שלך
          }
        });
      }

    }

    function toggleCoupon(event) {
      const toggle = event.target;
      const content = toggle.nextElementSibling;
      toggle.classList.toggle('active');
      content.classList.toggle('active');
      event.stopPropagation();
    }

    function copyCoupon(coupon, event) {
      navigator.clipboard.writeText(coupon)
        .then(() => alert('הקופון הועתק'))
        .catch(err => console.error('Failed to copy: ', err));
      event.stopPropagation();

      // Plausible analytics
      plausible('CouponCopy', { props: { coupon: coupon } });
    }

    let currentResults = [];

    function performPriceComparison(query) {
      showLoading();
      sortContainer.style.display = 'none';
      fetch(`https://kufu51g8uk.execute-api.il-central-1.amazonaws.com/stag/search?query=${encodeURIComponent(query)}&items=20`)
        .then(response => response.json())
        .then(data => {
          hideLoading();
          if (data.length === 0) {
            resultsContainer.innerHTML = '<p>לא נמצאו תוצאות להשוואת מחירים</p>';
          } else {
            currentResults = data;
            displayComparisonResults(data);
            sortContainer.style.display = 'block';
          }

          // Plausible analytics
          plausible('PriceComparison', { props: { query: query } });
        })
        .catch(error => {
          console.error('Error:', error);
          hideLoading();
          resultsContainer.innerHTML = '<p>אירעה שגיאה בהשוואת המחירים</p>';
        });
    }

    sortSelect.addEventListener('change', function () {
      const sortedResults = [...currentResults].sort((a, b) => {
        const priceA = parseFloat(a.price.replace(/[^\d.-]/g, ''));
        const priceB = parseFloat(b.price.replace(/[^\d.-]/g, ''));
        return this.value === 'price-asc' ? priceA - priceB : priceB - priceA;
      });
      displayComparisonResults(sortedResults);
    });

    function displayComparisonResults(results) {
      resultsContainer.innerHTML = '<div class="comparison-result"></div>';
      const comparisonContainer = resultsContainer.querySelector('.comparison-result');
      results.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'comparison-item';

        const siteInfo = findSiteInfo(product.url);

        let productContent = `
            <h3 onclick="goToProduct('${product.urlAff}', '${product.site}', '${product.name}')">${product.name}</h3>
            <p>מחיר: ${product.price}</p>
            <p>אתר: ${product.site}</p>
        `;

        if (siteInfo && siteInfo.cupon && siteInfo.cupon !== "") {
          productContent += `
                        <div class="coupon-details">
                            <button class="coupon-toggle">פרטי קופון</button>
                            <div class="coupon-content">
                                <span>${siteInfo.cupon}</span>
                                <span class="copy-icon" onclick="copyCoupon('${siteInfo.cupon}', event)">📋</span>
                                <a href="${product.urlAff}" class="site-link" target="_blank">עבור לאתר</a>
                                <p class="coupon-info">${siteInfo.cuponDetails || ''}</p>
                            </div>
                        </div>
                    `;
        } else {
          productContent += `<a href="${product.urlAff}" class="site-link" target="_blank">עבור לאתר</a>`;
        }

        productDiv.innerHTML = productContent;
        productDiv.querySelector('.coupon-toggle')?.addEventListener('click', toggleCoupon);
        comparisonContainer.appendChild(productDiv);
      });
    }

    function goToProduct(url, siteName, productName) {
      window.open(url, '_blank');

      // Plausible analytics
      plausible('ProductClick', {
        props: {
          site: siteName,
          product: productName,
          query: currentSearchQuery
        }
      });
    }

    function goToSite(url, siteName, linkType, event) {
  if (event) event.preventDefault();
  
  let finalUrl = url;
  
  // Find the site info
  const siteInfo = allSites.find(site => site.siteName === siteName);
  
  if (siteInfo) {
    if (searchedUrl && linkType === 'למוצר') {
      if (url.startsWith('https://track')) {
        finalUrl = `${url}?forceURL=${encodeURIComponent(searchedUrl)}`;
      } else {
        finalUrl = searchedUrl;
      }
    } else if (siteInfo.affParam) {
      // Check if the URL already has parameters
      const urlObj = new URL(finalUrl);
      const separator = urlObj.search ? '&' : '?';
      
      // Add affParam, ensuring we don't break the URL structure
      if (siteInfo.affParam.startsWith('/')) {
        // If affParam starts with '/', replace the entire path and search
        urlObj.pathname = siteInfo.affParam;
        urlObj.search = '';
      } else {
        // Otherwise, append it to the existing URL
        finalUrl = `${finalUrl}${separator}${siteInfo.affParam}`;
      }
    }
  }

  window.open(finalUrl, '_blank');
  
  plausible('SiteClick', { 
    props: { 
      site: siteName, 
      linkType: linkType,
      originalUrl: url,
      finalUrl: finalUrl
    } 
  });
}

    function findSiteInfo(url) {
      const parsedUrl = new URL(url);
      return allSites.find(site => {
        const siteUrl = new URL(site.URL);
        return siteUrl.hostname === parsedUrl.hostname;
      });
    }

    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      if (query) {
        search(query);
      } else {
        resultsContainer.innerHTML = '';
        compareButtonContainer.style.display = 'none';
      }
    });

    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        performPriceComparison(currentSearchQuery);
      }
    });

    compareButton.addEventListener('click', () => performPriceComparison(currentSearchQuery));

    clearSearch.addEventListener('click', () => {
      searchInput.value = '';
      resultsContainer.innerHTML = '';
      compareButtonContainer.style.display = 'none';
      currentSearchQuery = '';
    });

    // ביצוע חיפוש מיידי אם יש פרמטר query ב-URL
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('query');
    if (queryParam) {
      searchInput.value = queryParam;
      search(queryParam);
    }
  </script>
</body>

</html>