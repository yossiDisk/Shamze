<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <!-- Google tag (gtag.js) -->
    <script defer data-domain="yossidisk.github.io/shamze/sidesite.html"
        src="https://plausible.io/js/script.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תוצאות חיפוש</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0px;
            background-color: #f0f0f0;
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .product {
            border: 1px solid #ddd;
            padding: 15px;
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .product-image {
            width: 120px;
            height: 120px;
            margin-right: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f8f8;
            border-radius: 4px;
            overflow: hidden;
        }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-info {
            flex-grow: 1;
        }

        .product-info h3 {
            margin-top: 0;
            color: #333;
        }

        .product-info p {
            margin: 5px 0;
            color: #666;
        }

        .product-info a {
            color: #1a73e8;
            text-decoration: none;
        }

        .product-info a:hover {
            text-decoration: underline;
        }

        .loading-container {
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        .show-more-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .action-buttons {
            display: none;
        }

        .action-button {
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            text-decoration: none;
        }

        .product-header {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-header h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2em;
        }

        .product-header p {
            margin: 5px 0;
            color: #666;
        }

        .action-button:hover {
            background-color: #1558b3;
        }

        #copyMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }

        .show-more-button:hover {
            background-color: #1558b3;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sort-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div id="productHeader" class="product-header">
        <!-- Product details will be inserted here -->
    </div>

    <div class="sort-container">
        <label for="sort-select">מיין לפי:</label>
        <select id="sort-select" onchange="sortResults()">
            <option value="default">ברירת מחדל</option>
            <option value="price-asc">מחיר - מהנמוך לגבוה</option>
            <option value="price-desc">מחיר - מהגבוה לנמוך</option>
        </select>
    </div>

    <div id="loadingContainer" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <p>אוספים מוצרים מכל האתרים, זה יכול לקחת עד <span id="countdown">10</span> שניות...</p>
    </div>

    <div id="searchResults" class="search-results"></div>

    <script>
        // Add this at the beginning of your script
        function extractDomainFromUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.replace('www.', '');
            } catch (e) {
                return url;
            }
        }

        // Helper function to clean price string
        function cleanDisplayPrice(priceStr) {
            if (!priceStr) return null;
            // Remove ₪ and any non-numeric characters except commas and dots
            return priceStr.replace(/[₪]/g, '').trim();
        }

        function displayProductHeader() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query');
            const price = urlParams.get('price');
            const url = urlParams.get('url');

            const headerDiv = document.getElementById('productHeader');
            if (headerDiv) {
                let headerContent = `
            <div class="header-title-container" style="display: flex; align-items: center; gap: 10px; position: relative;">
                <h2 style="margin: 0;">${query || 'מוצר'}</h2>
                <div class="add-button-container" style="position: relative;">
                    <button 
                        class="add-to-list-button"
                        style="
                            background: none;
                            border: none;
                            cursor: pointer;
                            padding: 5px;
                            display: flex;
                            align-items: center;
                            font-family: inherit;
                            position: relative;
                            min-width: 30px;
                            overflow: hidden;
                            transition: all 0.3s ease;
                        "
                    >
                        <div class="button-content" style="
                            display: flex;
                            align-items: center;
                            position: relative;
                            transition: transform 0.3s ease;
                        ">
                            <span class="plus-icon" style="
                                font-size: 24px;
                                color: #1a73e8;
                                position: absolute;
                                right: 0;
                                transition: opacity 0.3s ease;
                            ">+</span>
                            <span class="button-text" style="
                                white-space: nowrap;
                                color: #1a73e8;
                                font-size: 14px;
                                opacity: 0;
                                transform: translateX(30px);
                                transition: all 0.3s ease;
                            ">+ רשימת קניות</span>
                        </div>
                    </button>
                </div>
                <div class="feature-message" style="
                    position: absolute;
                    top: 100%;
                    right: 0;
                    background-color: #333;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    margin-top: 8px;
                    font-size: 14px;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.3s ease;
                    z-index: 1000;
                ">הפיצר עדיין לא זמין</div>
            </div>
        `;

                // מציג מחיר רק אם קיים, לאחר ניקוי
                if (price) {
                    const cleanPrice = cleanDisplayPrice(price);
                    if (cleanPrice) {
                        headerContent += `<p>מחיר: ₪${cleanPrice}</p>`;
                    }
                }

                // מציג אתר רק אם קיים
                if (url) {
                    headerContent += `<p>אתר: ${extractDomainFromUrl(url)}</p>`;
                }

                headerDiv.innerHTML = headerContent;

                // Add button interactions
                const addButton = headerDiv.querySelector('.add-to-list-button');
                const buttonText = headerDiv.querySelector('.button-text');
                const plusIcon = headerDiv.querySelector('.plus-icon');
                const message = headerDiv.querySelector('.feature-message');
                let messageTimeout;

                if (addButton) {
                    // Hover interactions
                    addButton.addEventListener('mouseenter', function () {
                        buttonText.style.opacity = '1';
                        buttonText.style.transform = 'translateX(0)';
                        plusIcon.style.opacity = '0';
                        addButton.style.width = 'auto';

                        sendPlausibleEvent('AddToListButtonHover', {
                            productName: query || 'unknown'
                        });
                    });

                    addButton.addEventListener('mouseleave', function () {
                        buttonText.style.opacity = '0';
                        buttonText.style.transform = 'translateX(30px)';
                        plusIcon.style.opacity = '1';
                        addButton.style.width = '30px';
                    });

                    // Click interaction
                    addButton.addEventListener('click', function () {
                        // Clear any existing timeout
                        if (messageTimeout) {
                            clearTimeout(messageTimeout);
                        }

                        // Show message
                        message.style.visibility = 'visible';
                        message.style.opacity = '1';

                        // Hide message after 2 seconds
                        messageTimeout = setTimeout(() => {
                            message.style.opacity = '0';
                            setTimeout(() => {
                                message.style.visibility = 'hidden';
                            }, 300); // Wait for fade out animation to complete
                        }, 2000);

                        // Send Plausible event
                        sendPlausibleEvent('AddToListButtonClicked', {
                            productName: query || 'unknown',
                            price: cleanDisplayPrice(price) || 'unknown',
                            site: url ? extractDomainFromUrl(url) : 'unknown'
                        });
                    });
                }
            }
        }

        // Add this CSS to your existing styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
    .add-to-list-button:hover {
        background-color: rgba(26, 115, 232, 0.1);
        border-radius: 4px;
    }
    
    .feature-message::before {
        content: '';
        position: absolute;
        top: -6px;
        right: 10px;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-bottom: 6px solid #333;
    }
`;
        document.head.appendChild(styleSheet);

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            displayProductHeader();

            const queryParam = urlParams.get('query');
            if (queryParam) {
                search(queryParam).catch(error => {
                    console.error('Initial search failed:', error);
                });
            }
        });

        const imageCache = new Map();
        let logMessages = [];
        let currentResults = [];
        let currentSearchQuery = '';

        function log(message) {
            console.log(message);
            logMessages.push(message);
        }

        function displayLogs() {
            console.log("--- Full Log ---");
            console.log(logMessages.join('\n'));
            console.log("--- End Log ---");
        }

        function showLoadingSpinner() {
            document.getElementById('loadingContainer').style.display = 'block';
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingContainer').style.display = 'none';
        }

        function startCountdown() {
            let countdown = 10;
            const countdownElement = document.getElementById('countdown');
            const loadingContainer = document.getElementById('loadingContainer');

            if (!countdownElement || !loadingContainer) {
                console.error("Required elements not found");
                return;
            }

            console.log("Starting countdown");

            const intervalId = setInterval(() => {
                countdown--;
                console.log("Countdown: ", countdown);
                countdownElement.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(intervalId);
                    console.log("Countdown finished");

                    // בדיקה אם יש תוצאות
                    if (currentResults.length === 0) {
                        displayErrorMessage(`
                    <p>נותן לזה עוד רגע...</p>
                `);
                    }
                }
            }, 1000);
        }

        function displayErrorMessage(message) {
            const container = document.getElementById('searchResults');
            if (container) {
                container.innerHTML = message;
            } else {
                console.error("Search results container not found");
            }
        }
        function showLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.style.display = 'block';
                console.log("Loading container displayed");
                startCountdown();
            } else {
                console.error("Loading container not found");
            }
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.style.display = 'none';
                console.log("Loading container hidden");
            } else {
                console.error("Loading container not found");
            }
        }

        // Test function to simulate loading
        function testLoading() {
            showLoading();
            setTimeout(hideLoading, 11000); // Hide after 11 seconds
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Page loaded");
            testLoading();
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            if (typeof window.plausible === 'undefined') {
                console.warn('Plausible script not loaded. Attempting to load it manually.');
                loadPlausibleScript();
            } else {
                console.log('Plausible script already loaded.');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const feedbackLink = document.querySelector('.feedback-link');
            if (feedbackLink) {
                feedbackLink.addEventListener('click', () => {
                    sendPlausibleEvent('FeedbackLinkClicked');
                });
            }
        });

        let eventQueue = [];

        // פונקציה להוספת אירועים לתור
        function queueEvent(eventName, props) {
            eventQueue.push({ eventName, props });
        }

        function sendQueuedEvents() {
            if (typeof window.plausible === 'function' && eventQueue.length > 0) {
                console.log('Sending queued events to Plausible.');
                eventQueue.forEach(event => {
                    sendPlausibleEvent(event.eventName, event.props);
                });
                eventQueue = []; // ניקוי התור לאחר שליחת האירועים
            }
        }

        setInterval(sendQueuedEvents, 5000); // בדיקה כל 5 שניות

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // נעדכן את פונקציית החיפוש
        function search(query) {
            currentSearchQuery = query;
            showLoadingSpinner();
            log(`Starting search for query: ${query}`);

            // קריאת הפרמטרים הנוספים מה-URL
            const price = getUrlParameter('price');
            const referrerUrl = getUrlParameter('url');

            // שליחת אירוע Search עם הפרמטרים הנוספים
            sendPlausibleEvent('Search', {
                query: query || 'Not provided',
                price: price || 'Not provided',
                referrerUrl: referrerUrl || 'Not provided'
            });

            return new Promise((resolve, reject) => {
                fetchSearchResults(query)
                    .then(() => {
                        log('Search completed');
                        hideLoadingSpinner();
                        resolve();
                    })
                    .catch(error => {
                        log(`Error during search: ${error}`);
                        hideLoadingSpinner();
                        reject(error);
                    });
            });
        }

        // Add this helper function at the top of your script
        function cleanPriceString(priceStr) {
            if (!priceStr) return null;
            // Remove non-numeric characters except decimal point, convert to number
            return parseFloat(priceStr.replace(/[^\d.]/g, ''));
        }

        function fetchSearchResults(query) {
            showLoading();
            startCountdown();

            // Get and clean the price parameter from URL
            const priceParam = getUrlParameter('price');
            const cleanedPrice = cleanPriceString(priceParam);

            // Log the cleaning process
            console.log('Original price:', priceParam);
            console.log('Cleaned price:', cleanedPrice);

            // Construct the base URL with encoded query
            let apiUrl = `https://kufu51g8uk.execute-api.il-central-1.amazonaws.com/stag/search?query=${encodeURIComponent(query)}&items=10`;

            // Add price range parameters if we have a valid price
            if (cleanedPrice && cleanedPrice > 0) {
                const minPrice = Math.max(1, cleanedPrice * 0.5); // Ensure minimum price is at least 1
                const maxPrice = cleanedPrice * 1.5;

                // Log the price range calculation
                console.log('Price range:', { minPrice, maxPrice });

                apiUrl += `&minPrice=${minPrice.toFixed(2)}&maxPrice=${maxPrice.toFixed(2)}`;
            }

            // Log the final API URL
            console.log('API URL:', apiUrl);

            return fetch(apiUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                },
            })
                .then(response => {
                    // Log the response status
                    console.log('API Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Log the received data
                    console.log('Received data:', data);

                    if (!Array.isArray(data)) {
                        throw new Error('Invalid response format: expected array');
                    }

                    log(`Received ${data.length} search results`);
                    currentResults = data;
                    displaySearchResults(data);
                    hideLoading();

                    const searchStats = getSearchStats(data);
                    const eventProps = {
                        query: query,
                        resultCount: data.length,
                        cheapestProduct: searchStats.cheapest?.name || 'N/A',
                        cheapestSite: searchStats.cheapest?.site || 'N/A',
                        cheapestPrice: searchStats.cheapest?.price || 'N/A',
                        mostExpensiveProduct: searchStats.mostExpensive?.name || 'N/A',
                        mostExpensiveSite: searchStats.mostExpensive?.site || 'N/A',
                        mostExpensivePrice: searchStats.mostExpensive?.price || 'N/A',
                        averagePrice: searchStats.averagePrice || 'N/A'
                    };

                    sendPlausibleEvent('ResultsDisplayed', eventProps);
                })
                .catch(error => {
                    // Enhanced error logging
                    console.error('Search error details:', {
                        error: error.message,
                        query: query,
                        apiUrl: apiUrl,
                        timestamp: new Date().toISOString()
                    });

                    log(`Error fetching search results: ${error.message}`);
                    hideLoading();

                    const retryButtonHtml = `
            <div class="error-container" style="text-align: center; padding: 20px;">
                <p style="color: #666;">לא הצלחנו לטעון את התוצאות</p>
                <a id="retryButton" href="#" target="_blank" 
                   style="display: inline-block; margin: 10px; padding: 10px 20px; 
                   background-color: #1a73e8; color: white; text-decoration: none; 
                   border-radius: 4px;">נסה שוב</a>
                <p style="color: #666;">עדיין לא עובד?</p>
                <a href="https://mail.google.com/mail/?view=cm&fs=1&to=shamzezolyoter@gmail.com&su=פידבק על תוצאות החיפוש&body=היי, נראה שיש תקלה בטעינת תוצאות החיפוש:"
                   target="_blank" 
                   style="color: #1a73e8;">דווח על התקלה</a>
            </div>
        `;

                    displayErrorMessage(retryButtonHtml);

                    // Configure retry button
                    const retryButton = document.getElementById('retryButton');
                    if (retryButton) {
                        retryButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            const currentQuery = currentSearchQuery || '';
                            const retryUrl = `https://yossidisk.github.io/Shamze/cupons.html?source=side&search=true&query=${encodeURIComponent(currentQuery)}`;
                            window.open(retryUrl, '_blank');

                            sendPlausibleEvent('RetryButtonClicked', {
                                query: currentQuery,
                                error: error.message
                            });
                        });
                    }

                    sendPlausibleEvent('ResultsNotDisplayed', {
                        query: query,
                        error: error.message
                    });
                });
        }
        function getSearchStats(results) {
            let cheapest = results[0];
            let mostExpensive = results[0];
            let totalPrice = 0;

            results.forEach(product => {
                const price = parseFloat(product.price.replace(/[^\d.]/g, ''));

                if (price < parseFloat(cheapest.price.replace(/[^\d.]/g, ''))) {
                    cheapest = product;
                }
                if (price > parseFloat(mostExpensive.price.replace(/[^\d.]/g, ''))) {
                    mostExpensive = product;
                }

                totalPrice += price;
            });

            return {
                cheapest: cheapest,
                mostExpensive: mostExpensive,
                averagePrice: (totalPrice / results.length).toFixed(2)
            };
        }


        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            // הצג רק 3 תוצאות ראשונות
            const initialResults = results.slice(0, 3);
            const remainingResults = results.slice(3);

            initialResults.forEach(product => {
                const productDiv = createProductElement(product);
                container.appendChild(productDiv);
            });

            if (remainingResults.length > 0) {
                const showMoreButton = document.createElement('button');
                showMoreButton.textContent = 'עוד תוצאות';
                showMoreButton.className = 'show-more-button';
                showMoreButton.onclick = () => {
                    showMoreResults(remainingResults);
                    sendPlausibleEvent('ShowMoreResults', {
                        additionalResults: remainingResults.length
                    });
                };
                container.appendChild(showMoreButton);
            }
        }

        // פונקציה חדשה ליצירת אלמנט מוצר
        function createProductElement(product) {
            const productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.innerHTML = `
        <div class="product-info">
            <h3>${product.name}</h3>
            <p>מחיר: ${product.price}</p>
            <p>אתר: ${product.site}</p>
        </div>
        <div class="product-image"></div>
    `;
            productDiv.onclick = () => {
                logClick(product);
                window.open(product.urlAff, '_blank');
            };
            fetchProductImage(product.url, productDiv.querySelector('.product-image'));
            return productDiv;
        }

        // פונקציה חדשה להצגת תוצאות נוספות
        function showMoreResults(remainingResults) {
            const container = document.getElementById('searchResults');
            const showMoreButton = container.querySelector('.show-more-button');

            remainingResults.forEach(product => {
                const productDiv = createProductElement(product);
                container.insertBefore(productDiv, showMoreButton);
            });

            showMoreButton.remove();
        }

        function loadPlausibleScript() {
            const script = document.createElement('script');
            script.defer = true;
            script.setAttribute('data-domain', 'yossidisk.github.io/shamze/sidesite.html');
            script.src = 'https://plausible.io/js/script.js';
            script.onload = () => console.log('Plausible script loaded successfully.');
            script.onerror = () => console.error('Failed to load Plausible script.');
            document.head.appendChild(script);
        }

        function sendPlausibleEvent(eventName, props = {}) {
            if (typeof window.plausible === 'function') {
                try {
                    window.plausible(eventName, { props });
                    console.log(`Event sent to Plausible: ${eventName}`, props);
                } catch (error) {
                    console.error(`Error sending ${eventName} event to Plausible:`, error);
                }
            } else {
                console.warn(`Plausible not available for logging ${eventName} event. Queuing event.`);
                queueEvent(eventName, props);
            }
        }

        function logClick(product) {
            // בדיקה שהאובייקט product קיים ומכיל את השדה site
            if (!product || typeof product.site === 'undefined') {
                console.warn('Product data is incomplete:', product);
                return;
            }

            const clickData = {
                productName: product.name || 'unknown',
                targetSite: product.site || 'unknown',
                productPrice: product.price || 'unknown',
                searchQuery: currentSearchQuery || 'unknown',
                timestamp: new Date().toISOString()
            };

            console.log('Logging click:', clickData);

            if (window.plausible) {
                try {
                    window.plausible('ProductClick', {
                        props: {
                            productName: clickData.productName,
                            targetSite: clickData.targetSite,
                            productPrice: clickData.productPrice,
                            searchQuery: clickData.searchQuery
                        }
                    });
                } catch (error) {
                    console.error('Error sending data to Plausible:', error);
                }
            } else {
                console.warn('Plausible is not available');
            }

            let clicks = JSON.parse(localStorage.getItem('productClicks') || '[]');
            clicks.push(clickData);
            localStorage.setItem('productClicks', JSON.stringify(clicks));
        }

        function sortResults() {
            const sortType = document.getElementById('sort-select').value;
            let sortedResults = [...currentResults];

            if (sortType === 'price-asc' || sortType === 'price-desc') {
                sortedResults.sort((a, b) => {
                    const priceA = parseFloat(a.price.replace(/[^\d.]/g, ''));
                    const priceB = parseFloat(b.price.replace(/[^\d.]/g, ''));

                    if (isNaN(priceA)) return 1;
                    if (isNaN(priceB)) return -1;

                    return sortType === 'price-asc' ? priceA - priceB : priceB - priceA;
                });
            }
            sendPlausibleEvent('SortResults', { sortType });

            displaySearchResults(sortedResults);
        }

        function fetchProductImage(productUrl, imageContainer) {
            log(`Attempting to fetch image for product: ${productUrl}`);
            if (imageCache.has(productUrl)) {
                log(`Image found in cache for ${productUrl}`);
                displayImage(imageCache.get(productUrl), imageContainer);
                return;
            }

            const directImageUrl = buildDirectImageUrl(productUrl);
            if (directImageUrl) {
                tryLoadingDirectImage(directImageUrl, productUrl, imageContainer);
                return;
            }

            fetch(productUrl)
                .then(response => {
                    log(`Received response from ${productUrl}. Status: ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    log(`Successfully fetched HTML for ${productUrl}`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    findAndLoadImage(doc, productUrl, imageContainer);
                })
                .catch(error => {
                    log(`Error fetching product page ${productUrl}: ${error}`);
                    console.error('Error fetching product page:', error);
                    imageContainer.style.display = 'none';
                });
        }

        function buildDirectImageUrl(productUrl) {
            if (productUrl.includes('zap.co.il')) {
                const sku = productUrl.match(/(\d+)$/)?.[1];
                if (sku) return `https://img.zap.co.il/pics/new/${sku}.gif`;
            }
            if (productUrl.includes('ksp.co.il')) {
                const sku = productUrl.match(/item\/(\d+)/)?.[1];
                if (sku) return `https://img.ksp.co.il/item/${sku}/b_1.jpg`;
            }
            return null;
        }

        function tryLoadingDirectImage(imageUrl, productUrl, imageContainer) {
            const img = new Image();
            img.onload = () => {
                log(`Direct image successfully loaded: ${imageUrl}`);
                imageCache.set(productUrl, imageUrl);
                displayImage(imageUrl, imageContainer);
            };
            img.onerror = () => {
                log(`Failed to load direct image: ${imageUrl}. Falling back to HTML parsing.`);
                fetch(productUrl)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        findAndLoadImage(doc, productUrl, imageContainer);
                    })
                    .catch(error => {
                        log(`Error fetching product page ${productUrl}: ${error}`);
                        imageContainer.style.display = 'none';
                    });
            };
            img.src = imageUrl;
        }

        function findAndLoadImage(doc, baseUrl, imageContainer) {
            log(`Searching for image in document from ${baseUrl}`);
            const imageFinders = [
                // ... (כל שיטות החיפוש הקודמות נשארות ללא שינוי)
            ];

            tryNextImage(imageFinders, 0, baseUrl, imageContainer);
        }

        function tryNextImage(finders, index, baseUrl, imageContainer) {
            if (index >= finders.length) {
                log(`All image finding methods exhausted for ${baseUrl}. No image found.`);
                imageContainer.style.display = 'none';
                return;
            }

            log(`Trying image finder method ${index + 1} for ${baseUrl}`);
            let imageUrl = finders[index]();

            if (imageUrl) {
                log(`Image URL found: ${imageUrl}`);
                if (imageUrl.startsWith('/')) {
                    const urlObj = new URL(baseUrl);
                    imageUrl = `${urlObj.protocol}//${urlObj.hostname}${imageUrl}`;
                    log(`Relative URL converted to absolute: ${imageUrl}`);
                } else if (!imageUrl.startsWith('http')) {
                    imageUrl = new URL(imageUrl, baseUrl).href;
                    log(`Relative URL converted to absolute: ${imageUrl}`);
                }

                const img = new Image();
                img.onload = () => {
                    log(`Image successfully loaded: ${imageUrl}`);
                    imageCache.set(baseUrl, imageUrl);
                    displayImage(imageUrl, imageContainer);
                };
                img.onerror = () => {
                    log(`Failed to load image: ${imageUrl}`);
                    tryNextImage(finders, index + 1, baseUrl, imageContainer);
                };
                img.src = imageUrl;
            } else {
                log(`No image URL found with method ${index + 1}. Trying next method.`);
                tryNextImage(finders, index + 1, baseUrl, imageContainer);
            }
        }

        function displayImage(imageUrl, container) {
            container.style.display = 'flex';
            container.innerHTML = '';
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'תמונת מוצר';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            container.appendChild(img);
        }

        // ביצוע חיפוש מיידי אם יש פרמטר query ב-URL
        const urlParams = new URLSearchParams(window.location.search);
        const queryParam = urlParams.get('query');
        const priceParam = urlParams.get('price');
        const urlParam = urlParams.get('url');

        if (queryParam) {
            search(queryParam).then(() => {
                displayLogs();
            }).catch(error => {
                console.error('Initial search failed:', error);
                displayLogs();
            });
        }
    </script>
</body>

</html>