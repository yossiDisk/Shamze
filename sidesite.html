<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <!-- Google tag (gtag.js) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script defer data-domain="yossidisk.github.io/shamze/sidesite.html"
        src="https://plausible.io/js/script.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תוצאות חיפוש</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0px;
            background-color: #f0f0f0;
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .product {
            border: 1px solid #ddd;
            padding: 15px;
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .product-image {
            width: 120px;
            height: 120px;
            margin-right: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f8f8;
            border-radius: 4px;
            overflow: hidden;
        }

        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .product-info {
            flex-grow: 1;
        }

        .product-info h3 {
            margin-top: 0;
            color: #333;
        }

        .product-info p {
            margin: 5px 0;
            color: #666;
        }

        .product-info a {
            color: #1a73e8;
            text-decoration: none;
        }

        .product-info a:hover {
            text-decoration: underline;
        }

        .loading-container {
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        .show-more-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .action-buttons {
            display: none;
        }

        .action-button {
            padding: 10px 20px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            text-decoration: none;
        }

        .product-header {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-header h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2em;
        }

        .product-header p {
            margin: 5px 0;
            color: #666;
        }

        .action-button:hover {
            background-color: #1558b3;
        }

        #copyMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }

        .show-more-button:hover {
            background-color: #1558b3;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sort-container {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div id="productHeader" class="product-header">
        <!-- Product details will be inserted here -->
    </div>

    <div class="sort-container">
        <label for="sort-select">מיין לפי:</label>
        <select id="sort-select" onchange="sortResults()">
            <option value="default">ברירת מחדל</option>
            <option value="price-asc">מחיר - מהנמוך לגבוה</option>
            <option value="price-desc">מחיר - מהגבוה לנמוך</option>
        </select>
    </div>

    <div id="loadingContainer" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <p>אוספים מוצרים מכל האתרים, זה יכול לקחת עד <span id="countdown">10</span> שניות...</p>
    </div>

    <div id="searchResults" class="search-results"></div>

    <script>
        // Add this at the beginning of your script
        function extractDomainFromUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.replace('www.', '');
            } catch (e) {
                return url;
            }
        }

        // Helper function to clean and validate price
        function cleanDisplayPrice(priceStr) {
            if (!priceStr) return null;
            // Remove ₪ and any non-numeric characters except commas and dots
            const cleanPrice = priceStr.replace(/[₪]/g, '').trim();
            // Convert to number for comparison (remove commas first)
            const numPrice = parseFloat(cleanPrice.replace(/,/g, ''));
            // Return null if price is 0 or NaN
            return (!numPrice || isNaN(numPrice)) ? null : cleanPrice;
        }

        function displayProductHeader() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query');
            const price = urlParams.get('price');
            const url = urlParams.get('url');

            const headerDiv = document.getElementById('productHeader');
            if (headerDiv) {
                let headerContent = `
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(26, 115, 232, 0.2);
            border-top: 2px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
    <div style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Product Title -->
                <h2 style="
                    margin: 0;
                    font-size: 16px;
                    line-height: 1.2;
                ">${query || 'מוצר'}</h2>
                
                <!-- Price and Site Grid -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                    margin-bottom: 6px;
                ">`;

                // מציג מחיר רק אם קיים וגדול מ-0
                const cleanPrice = cleanDisplayPrice(price);
                if (cleanPrice) {
                    headerContent += `
                    <div style="
                        background: #f8f9fa;
                        padding: 6px 10px;
                        border-radius: 4px;
                        text-align: center;
                        font-size: 14px;
                    ">₪${cleanPrice}</div>`;
                }

                // מציג אתר רק אם קיים
                if (url) {
                    headerContent += `
                    <div style="
                        background: #f8f9fa;
                        padding: 6px 10px;
                        border-radius: 4px;
                        text-align: center;
                        font-size: 14px;
                    ">${extractDomainFromUrl(url)}</div>`;
                }

                headerContent += `
                </div>

                <!-- Buttons Container -->
                <div style="display: flex; gap: 8px; align-items: center; position: relative;">
                    <button 
                        class="add-to-list-button"
                        style="
                            flex-grow: 1;
                            background: none;
                            border: 1px dashed #1a73e8;
                            border-radius: 4px;
                            cursor: pointer;
                            padding: 6px;
                            color: #1a73e8;
                            font-family: inherit;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                            transition: all 0.3s ease;
                            font-size: 13px;
                            min-width: 40px;
                        "
                    >
                        <span style="font-size: 16px; min-width: 16px;">+</span>
                        <span class="add-list-text" style="transition: opacity 0.3s ease;">הוסף לרשימת קניות</span>
                    </button>
                    <div id="googleAuthContainer"></div>
                </div>

                <!-- Feature Message -->
                <div class="feature-message" style="
                    position: absolute;
                    bottom: -35px;
                    right: 0;
                    left: 0;
                    background-color: #333;
                    color: white;
                    padding: 12px;
                    border-radius: 4px;
                    font-size: 13px;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.3s ease;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 10px;
                ">
                    <span class="message-text">נא להתחבר כדי להוסיף לרשימה</span>
                    <div class="message-actions" style="display: flex; align-items: center; gap: 10px;">
                        <div id="messageGoogleSignIn"></div>
                        <button class="close-message" style="
                            background: none;
                            border: none;
                            color: white;
                            cursor: pointer;
                            padding: 4px;
                            font-size: 18px;
                            line-height: 1;
                        ">×</button>
                    </div>
                </div>
            </div>
        `;

                headerDiv.innerHTML = headerContent;

                // Add button interactions
                const addButton = headerDiv.querySelector('.add-to-list-button');
                const message = headerDiv.querySelector('.feature-message');
                let messageTimeout;

                if (addButton) {
                    // Hover effect
                    addButton.addEventListener('mouseenter', function () {
                        this.style.backgroundColor = 'rgba(26, 115, 232, 0.1)';

                        sendPlausibleEvent('AddToListButtonHover', {
                            productName: query || 'unknown'
                        });
                    });

                    addButton.addEventListener('mouseleave', function () {
                        this.style.backgroundColor = 'transparent';
                    });

                    // Click interaction
                    addButton.addEventListener('click', async function () {
                        if (messageTimeout) {
                            clearTimeout(messageTimeout);
                        }

                        // בדיקה אם המשתמש מחובר
                        if (!currentUser) {
                            const messageGoogleSignIn = document.getElementById('messageGoogleSignIn');
                            const closeButton = message.querySelector('.close-message');

                            message.style.visibility = 'visible';
                            message.style.opacity = '1';

                            // רינדור כפתור גוגל בתוך ההודעה
                            google.accounts.id.renderButton(
                                messageGoogleSignIn,
                                {
                                    type: 'icon',
                                    shape: 'circular',
                                    theme: 'outline',
                                    size: 'medium'
                                }
                            );

                            // טיפול בסגירת ההודעה
                            closeButton.onclick = () => {
                                message.style.opacity = '0';
                                setTimeout(() => {
                                    message.style.visibility = 'hidden';
                                }, 300);
                            };

                            // הודעה נעלמת אוטומטית אחרי 4 שניות
                            messageTimeout = setTimeout(() => {
                                message.style.opacity = '0';
                                setTimeout(() => {
                                    message.style.visibility = 'hidden';
                                }, 300);
                            }, 4000);

                            return;
                        }

                        // שמירת התוכן המקורי והצגת טעינה
                        const originalContent = this.innerHTML;
                        this.innerHTML = '<div class="loading-spinner"></div>';
                        this.style.opacity = '0.7';
                        this.disabled = true;

                        const productData = {
                            userId: currentUser.userId,
                            productName: query || 'מוצר לא ידוע',
                            price: cleanPrice,
                            site: url ? extractDomainFromUrl(url) : undefined,
                            productUrl: url
                        };

                        console.log('Sending data:', productData);

                        try {
                            const response = await fetch('https://1dj3mvq3i6.execute-api.il-central-1.amazonaws.com/prod/list', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(productData)
                            });

                            if (response.ok) {
                                message.textContent = 'המוצר נוסף לרשימה בהצלחה';
                                sendPlausibleEvent('ProductAddedToList', {
                                    productName: query || 'unknown',
                                    price: cleanPrice || 'unknown',
                                    site: url ? extractDomainFromUrl(url) : 'unknown'
                                });
                            } else {
                                throw new Error('Server responded with error');
                            }
                        } catch (error) {
                            console.error('Error adding to list:', error);
                            message.textContent = 'אירעה שגיאה בהוספה לרשימה';
                        } finally {
                            // החזרת הכפתור למצב המקורי
                            this.innerHTML = originalContent;
                            this.style.opacity = '1';
                            this.disabled = false;

                            message.style.visibility = 'visible';
                            message.style.opacity = '1';

                            messageTimeout = setTimeout(() => {
                                message.style.opacity = '0';
                                setTimeout(() => {
                                    message.style.visibility = 'hidden';
                                }, 300);
                            }, 2000);
                        }
                    });
                }
            }
        }

        // Add this CSS to your existing styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
    .product-header {
        position: relative;
        padding: 10px;
        padding-bottom: 15px;
    }
`;
        document.head.appendChild(styleSheet);

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            displayProductHeader();

            const queryParam = urlParams.get('query');
            if (queryParam) {
                search(queryParam).catch(error => {
                    console.error('Initial search failed:', error);
                });
            }
        });

        // משתנה גלובלי לשמירת פרטי המשתמש
        let currentUser = null;

        function renderGoogleSignIn(container) {
            container.innerHTML = '';

            // יצירת הקונטיינר לכפתור
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'auth-button-container';
            buttonContainer.style.cssText = `
        position: relative;
        overflow: hidden;
        height: 40px;
        min-width: 40px;
        transition: min-width 0.3s ease;
        z-index: 1000;
    `;

            // יצירת הכפתור
            const button = document.createElement('button');
            button.className = 'auth-button';
            button.style.cssText = `
        width: auto;
        height: 40px;
        padding: 0;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        white-space: nowrap;
        position: absolute;
        right: 0;
        transition: all 0.3s ease;
    `;

            // אתחול הגדרות גוגל
            google.accounts.id.initialize({
                client_id: "33228757731-fjpimc9l48l3qa8cbt9srtao49ln46ev.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });

            // רינדור כפתור גוגל בתוך הכפתור
            google.accounts.id.renderButton(
                button,
                {
                    type: 'icon',
                    shape: 'circular',
                    theme: 'outline',
                    size: 'large'
                }
            );

            // הוספת טקסט וטיפול באפקטים
            const text = document.createElement('span');
            text.textContent = 'התחבר עם Google';
            text.style.cssText = `
        padding: 0 16px 0 10px;
        font-size: 14px;
        color: #3c4043;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
            button.appendChild(text);

            buttonContainer.addEventListener('mouseenter', () => {
                buttonContainer.style.minWidth = '180px';
                text.style.opacity = '1';
                // הסתר את הטקסט בכפתור הראשון
                const addListText = document.querySelector('.add-list-text');
                if (addListText) {
                    addListText.style.display = 'none';
                }
            });

            buttonContainer.addEventListener('mouseleave', () => {
                buttonContainer.style.minWidth = '40px';
                text.style.opacity = '0';
                // הצג שוב את הטקסט בכפתור הראשון
                const addListText = document.querySelector('.add-list-text');
                if (addListText) {
                    addListText.style.display = 'block';
                }
            });

            // לחצן התחברות עם גוגל
            button.onclick = () => {
                google.accounts.id.prompt();
            };

            buttonContainer.appendChild(button);
            container.appendChild(buttonContainer);
        }

        // פונקציה לבדיקת מצב התחברות בטעינת הדף
        function checkLoginStatus() {
            const container = document.getElementById('googleAuthContainer');

            // בדיקה אם יש טוקן בלוקאל סטורג'
            const token = localStorage.getItem('googleToken');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    if (payload.exp * 1000 > Date.now()) {
                        currentUser = {
                            email: payload.email,
                            name: payload.name,
                            userId: payload.sub
                        };
                        // מציג כפתור רשימת קניות
                        renderShoppingListButton(container);
                    } else {
                        localStorage.removeItem('googleToken');
                        // מציג כפתור התחברות
                        renderGoogleSignIn(container);
                    }
                } catch (error) {
                    console.error('Error parsing token:', error);
                    localStorage.removeItem('googleToken');
                    renderGoogleSignIn(container);
                }
            } else {
                renderGoogleSignIn(container);
            }
        }


        // פונקציה להצגת כפתור רשימת קניות
        function renderShoppingListButton(container) {
            container.innerHTML = '';

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'auth-button-container';
            buttonContainer.style.cssText = `
        position: relative;
        overflow: hidden;
        height: 40px;
        min-width: 40px;
        transition: min-width 0.3s ease;
        z-index: 1000;  /* נוסף */
    `;

            const button = document.createElement('button');
            button.className = 'auth-button';
            button.style.cssText = `
        width: auto;
        height: 40px;
        padding: 0;
        background: #1a73e8;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        white-space: nowrap;
        position: absolute;
        right: 0;
        color: white;
        transition: all 0.3s ease;
    `;

            const iconContainer = document.createElement('div');
            iconContainer.style.cssText = `
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

            // Shopping list icon
            iconContainer.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"/>
        </svg>
    `;

            const text = document.createElement('span');
            text.textContent = 'רשימת הקניות שלי';
            text.style.cssText = `
        padding: 0 16px 0 10px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;

            button.appendChild(iconContainer);
            button.appendChild(text);
            buttonContainer.appendChild(button);

            buttonContainer.addEventListener('mouseenter', () => {
                buttonContainer.style.minWidth = '180px';
                text.style.opacity = '1';
                // הסתר את הטקסט בכפתור הראשון
                const addListText = document.querySelector('.add-list-text');
                if (addListText) {
                    addListText.style.display = 'none';
                }
            });

            buttonContainer.addEventListener('mouseleave', () => {
                buttonContainer.style.minWidth = '40px';
                text.style.opacity = '0';
                // הצג שוב את הטקסט בכפתור הראשון
                const addListText = document.querySelector('.add-list-text');
                if (addListText) {
                    addListText.style.display = 'block';
                }
            });

            button.onclick = () => {
                sendPlausibleEvent('ShoppingListOpened', {
                    userId: currentUser.userId
                });
                window.open('/Shamze/shopping-list.html', '_blank');
            };

            container.appendChild(buttonContainer);
        }
        // מוודאים שה-script של Google נטען
        function waitForGoogleScript() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                checkLoginStatus();
            } else {
                setTimeout(waitForGoogleScript, 100);
            }
        }

        // קוראים לפונקציה כשהדף נטען
        document.addEventListener('DOMContentLoaded', () => {
            waitForGoogleScript();
        });

        // פונקציה להצגת כפתור ההתחברות של גוגל
        function showGoogleSignIn() {
            const googleSignInButton = document.querySelector('.g_id_signin');
            if (googleSignInButton) {
                googleSignInButton.style.display = 'block';
            }
        }

        function handleCredentialResponse(response) {
            const token = response.credential;
            localStorage.setItem('googleToken', token);

            const payload = JSON.parse(atob(token.split('.')[1]));
            currentUser = {
                email: payload.email,
                name: payload.name,
                userId: payload.sub
            };

            // Clear and update UI
            const googleAuthContainer = document.getElementById('googleAuthContainer');
            if (googleAuthContainer) {
                googleAuthContainer.innerHTML = '';
            }

            updateUIForLoggedInUser();

            sendPlausibleEvent('UserLogin', {
                email: currentUser.email
            });
        }

        // הוספת קריאה לפונקציה בטעינת הדף
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

        function updateUIForLoggedInUser() {
            // החלפת כפתור התחברות עם לינק לרשימת קניות
            const googleAuthContainer = document.getElementById('googleAuthContainer');
            if (googleAuthContainer) {
                // ניקוי כל התוכן הקיים
                googleAuthContainer.innerHTML = '';

                // מוסיף כפתור לרשימת קניות
                const shoppingListButton = document.createElement('button');
                shoppingListButton.className = 'action-button';
                shoppingListButton.style.cssText = `
            padding: 8px 16px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        `;
                shoppingListButton.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
            רשימת הקניות שלי
        `;

                shoppingListButton.onclick = () => {
                    sendPlausibleEvent('ShoppingListOpened', {
                        userId: currentUser.userId
                    });
                    window.open('/Shamze/shopping-list.html', '_blank');
                };

                googleAuthContainer.appendChild(shoppingListButton);
            }

            // עדכון כפתור "הוסף לרשימה" שיעבוד
            const addButton = document.querySelector('.add-to-list-button');
            if (addButton) {
                addButton.textContent = '+ הוסף לרשימת הקניות';
                addButton.style.backgroundColor = 'rgba(26, 115, 232, 0.1)';
                addButton.style.color = '#1a73e8';
            }

            // מעדכן את הודעת ההצלחה
            const featureMessage = document.querySelector('.feature-message');
            if (featureMessage) {
                featureMessage.textContent = 'המוצר נוסף לרשימה בהצלחה';
            }
        }

        // פונקציה להוספה לרשימת קניות
        async function addToShoppingList() {
            if (!currentUser) {
                const message = document.querySelector('.feature-message');
                message.textContent = 'נא להתחבר כדי להוסיף לרשימה';
                message.style.visibility = 'visible';
                message.style.opacity = '1';

                // Add the Google Sign-In button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'auth-button-container';
                message.appendChild(buttonContainer);
                renderGoogleSignIn(buttonContainer);

                // Hide the message after 4 seconds
                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.style.visibility = 'hidden';
                    }, 300);
                }, 4000);
                return;
            }

            // Rest of the addToShoppingList function remains the same
            const urlParams = new URLSearchParams(window.location.search);
            const productData = {
                userId: currentUser.userId,
                productName: urlParams.get('query') || 'מוצר לא ידוע',
                price: urlParams.get('price'),
                site: extractDomainFromUrl(urlParams.get('url')),
                productUrl: urlParams.get('url')
            };

            console.log('Sending data:', productData);

            try {
                const response = await fetch('https://1dj3mvq3i6.execute-api.il-central-1.amazonaws.com/prod/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    const message = document.querySelector('.feature-message');
                    message.textContent = 'המוצר נוסף לרשימה בהצלחה';
                    message.style.visibility = 'visible';
                    message.style.opacity = '1';

                    setTimeout(() => {
                        message.style.opacity = '0';
                        setTimeout(() => {
                            message.style.visibility = 'hidden';
                        }, 300);
                    }, 4000);
                } else {
                    throw new Error('Server responded with error');
                }
            } catch (error) {
                console.error('Error adding to list:', error);
                const message = document.querySelector('.feature-message');
                message.textContent = 'אירעה שגיאה בהוספה לרשימה';
                message.style.visibility = 'visible';
                message.style.opacity = '1';

                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.style.visibility = 'hidden';
                    }, 300);
                }, 4000);
            }
        }

        const imageCache = new Map();
        let logMessages = [];
        let currentResults = [];
        let currentSearchQuery = '';

        function log(message) {
            console.log(message);
            logMessages.push(message);
        }

        function displayLogs() {
            console.log("--- Full Log ---");
            console.log(logMessages.join('\n'));
            console.log("--- End Log ---");
        }

        function showLoadingSpinner() {
            document.getElementById('loadingContainer').style.display = 'block';
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingContainer').style.display = 'none';
        }

        function startCountdown() {
            let countdown = 10;
            const countdownElement = document.getElementById('countdown');
            const loadingContainer = document.getElementById('loadingContainer');

            if (!countdownElement || !loadingContainer) {
                console.error("Required elements not found");
                return;
            }

            console.log("Starting countdown");

            const intervalId = setInterval(() => {
                countdown--;
                console.log("Countdown: ", countdown);
                countdownElement.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(intervalId);
                    console.log("Countdown finished");

                    // בדיקה אם יש תוצאות
                    if (currentResults.length === 0) {
                        displayErrorMessage(`
                    <p>נותן לזה עוד רגע...</p>
                `);
                    }
                }
            }, 1000);
        }

        function displayErrorMessage(message) {
            const container = document.getElementById('searchResults');
            if (container) {
                container.innerHTML = message;
            } else {
                console.error("Search results container not found");
            }
        }
        function showLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.style.display = 'block';
                console.log("Loading container displayed");
                startCountdown();
            } else {
                console.error("Loading container not found");
            }
        }

        function hideLoading() {
            const loadingContainer = document.getElementById('loadingContainer');
            if (loadingContainer) {
                loadingContainer.style.display = 'none';
                console.log("Loading container hidden");
            } else {
                console.error("Loading container not found");
            }
        }

        // Test function to simulate loading
        function testLoading() {
            showLoading();
            setTimeout(hideLoading, 11000); // Hide after 11 seconds
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Page loaded");
            testLoading();
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            if (typeof window.plausible === 'undefined') {
                console.warn('Plausible script not loaded. Attempting to load it manually.');
                loadPlausibleScript();
            } else {
                console.log('Plausible script already loaded.');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const feedbackLink = document.querySelector('.feedback-link');
            if (feedbackLink) {
                feedbackLink.addEventListener('click', () => {
                    sendPlausibleEvent('FeedbackLinkClicked');
                });
            }
        });

        let eventQueue = [];

        // פונקציה להוספת אירועים לתור
        function queueEvent(eventName, props) {
            eventQueue.push({ eventName, props });
        }

        function sendQueuedEvents() {
            if (typeof window.plausible === 'function' && eventQueue.length > 0) {
                console.log('Sending queued events to Plausible.');
                eventQueue.forEach(event => {
                    sendPlausibleEvent(event.eventName, event.props);
                });
                eventQueue = []; // ניקוי התור לאחר שליחת האירועים
            }
        }

        setInterval(sendQueuedEvents, 5000); // בדיקה כל 5 שניות

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // נעדכן את פונקציית החיפוש
        function search(query) {
            currentSearchQuery = query;
            showLoadingSpinner();
            log(`Starting search for query: ${query}`);

            // קריאת הפרמטרים הנוספים מה-URL
            const price = getUrlParameter('price');
            const referrerUrl = getUrlParameter('url');

            // שליחת אירוע Search עם הפרמטרים הנוספים
            sendPlausibleEvent('Search', {
                query: query || 'Not provided',
                price: price || 'Not provided',
                referrerUrl: referrerUrl || 'Not provided'
            });

            return new Promise((resolve, reject) => {
                fetchSearchResults(query)
                    .then(() => {
                        log('Search completed');
                        hideLoadingSpinner();
                        resolve();
                    })
                    .catch(error => {
                        log(`Error during search: ${error}`);
                        hideLoadingSpinner();
                        reject(error);
                    });
            });
        }

        // Add this helper function at the top of your script
        function cleanPriceString(priceStr) {
            if (!priceStr) return null;
            // Remove non-numeric characters except decimal point, convert to number
            return parseFloat(priceStr.replace(/[^\d.]/g, ''));
        }

        function fetchSearchResults(query) {
            showLoading();
            startCountdown();

            // Get and clean the price parameter from URL
            const priceParam = getUrlParameter('price');
            const cleanedPrice = cleanPriceString(priceParam);

            // Log the cleaning process
            console.log('Original price:', priceParam);
            console.log('Cleaned price:', cleanedPrice);

            // Construct the base URL with encoded query
            let apiUrl = `https://kufu51g8uk.execute-api.il-central-1.amazonaws.com/stag/search?query=${encodeURIComponent(query)}&items=10`;

            // Add price range parameters if we have a valid price
            if (cleanedPrice && cleanedPrice > 0) {
                const minPrice = Math.max(1, cleanedPrice * 0.5); // Ensure minimum price is at least 1
                const maxPrice = cleanedPrice * 1.5;

                // Log the price range calculation
                console.log('Price range:', { minPrice, maxPrice });

                apiUrl += `&minPrice=${minPrice.toFixed(2)}&maxPrice=${maxPrice.toFixed(2)}`;
            }

            // Log the final API URL
            console.log('API URL:', apiUrl);

            return fetch(apiUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                },
            })
                .then(response => {
                    // Log the response status
                    console.log('API Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Log the received data
                    console.log('Received data:', data);

                    if (!Array.isArray(data)) {
                        throw new Error('Invalid response format: expected array');
                    }

                    log(`Received ${data.length} search results`);
                    currentResults = data;
                    displaySearchResults(data);
                    hideLoading();

                    const searchStats = getSearchStats(data);
                    const eventProps = {
                        query: query,
                        resultCount: data.length,
                        cheapestProduct: searchStats.cheapest?.name || 'N/A',
                        cheapestSite: searchStats.cheapest?.site || 'N/A',
                        cheapestPrice: searchStats.cheapest?.price || 'N/A',
                        mostExpensiveProduct: searchStats.mostExpensive?.name || 'N/A',
                        mostExpensiveSite: searchStats.mostExpensive?.site || 'N/A',
                        mostExpensivePrice: searchStats.mostExpensive?.price || 'N/A',
                        averagePrice: searchStats.averagePrice || 'N/A'
                    };

                    sendPlausibleEvent('ResultsDisplayed', eventProps);
                })
                .catch(error => {
                    // Enhanced error logging
                    console.error('Search error details:', {
                        error: error.message,
                        query: query,
                        apiUrl: apiUrl,
                        timestamp: new Date().toISOString()
                    });

                    log(`Error fetching search results: ${error.message}`);
                    hideLoading();

                    const retryButtonHtml = `
            <div class="error-container" style="text-align: center; padding: 20px;">
                <p style="color: #666;">לא הצלחנו לטעון את התוצאות</p>
                <a id="retryButton" href="#" target="_blank" 
                   style="display: inline-block; margin: 10px; padding: 10px 20px; 
                   background-color: #1a73e8; color: white; text-decoration: none; 
                   border-radius: 4px;">נסה שוב</a>
                <p style="color: #666;">עדיין לא עובד?</p>
                <a href="https://mail.google.com/mail/?view=cm&fs=1&to=shamzezolyoter@gmail.com&su=פידבק על תוצאות החיפוש&body=היי, נראה שיש תקלה בטעינת תוצאות החיפוש:"
                   target="_blank" 
                   style="color: #1a73e8;">דווח על התקלה</a>
            </div>
        `;

                    displayErrorMessage(retryButtonHtml);

                    // Configure retry button
                    const retryButton = document.getElementById('retryButton');
                    if (retryButton) {
                        retryButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            const currentQuery = currentSearchQuery || '';
                            const retryUrl = `https://yossidisk.github.io/Shamze/cupons.html?source=side&search=true&query=${encodeURIComponent(currentQuery)}`;
                            window.open(retryUrl, '_blank');

                            sendPlausibleEvent('RetryButtonClicked', {
                                query: currentQuery,
                                error: error.message
                            });
                        });
                    }

                    sendPlausibleEvent('ResultsNotDisplayed', {
                        query: query,
                        error: error.message
                    });
                });
        }
        function getSearchStats(results) {
            let cheapest = results[0];
            let mostExpensive = results[0];
            let totalPrice = 0;

            results.forEach(product => {
                const price = parseFloat(product.price.replace(/[^\d.]/g, ''));

                if (price < parseFloat(cheapest.price.replace(/[^\d.]/g, ''))) {
                    cheapest = product;
                }
                if (price > parseFloat(mostExpensive.price.replace(/[^\d.]/g, ''))) {
                    mostExpensive = product;
                }

                totalPrice += price;
            });

            return {
                cheapest: cheapest,
                mostExpensive: mostExpensive,
                averagePrice: (totalPrice / results.length).toFixed(2)
            };
        }


        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            // הצג רק 3 תוצאות ראשונות
            const initialResults = results.slice(0, 3);
            const remainingResults = results.slice(3);

            initialResults.forEach(product => {
                const productDiv = createProductElement(product);
                container.appendChild(productDiv);
            });

            if (remainingResults.length > 0) {
                const showMoreButton = document.createElement('button');
                showMoreButton.textContent = 'עוד תוצאות';
                showMoreButton.className = 'show-more-button';
                showMoreButton.onclick = () => {
                    showMoreResults(remainingResults);
                    sendPlausibleEvent('ShowMoreResults', {
                        additionalResults: remainingResults.length
                    });
                };
                container.appendChild(showMoreButton);
            }
        }

        // פונקציה חדשה ליצירת אלמנט מוצר
        function createProductElement(product) {
            const productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.innerHTML = `
        <div class="product-info">
            <h3>${product.name}</h3>
            <p>מחיר: ${product.price}</p>
            <p>אתר: ${product.site}</p>
        </div>
        <div class="product-image"></div>
    `;
            productDiv.onclick = () => {
                logClick(product);
                window.open(product.urlAff, '_blank');
            };
            fetchProductImage(product.url, productDiv.querySelector('.product-image'));
            return productDiv;
        }

        // פונקציה חדשה להצגת תוצאות נוספות
        function showMoreResults(remainingResults) {
            const container = document.getElementById('searchResults');
            const showMoreButton = container.querySelector('.show-more-button');

            remainingResults.forEach(product => {
                const productDiv = createProductElement(product);
                container.insertBefore(productDiv, showMoreButton);
            });

            showMoreButton.remove();
        }

        function loadPlausibleScript() {
            const script = document.createElement('script');
            script.defer = true;
            script.setAttribute('data-domain', 'yossidisk.github.io/shamze/sidesite.html');
            script.src = 'https://plausible.io/js/script.js';
            script.onload = () => console.log('Plausible script loaded successfully.');
            script.onerror = () => console.error('Failed to load Plausible script.');
            document.head.appendChild(script);
        }

        function sendPlausibleEvent(eventName, props = {}) {
            if (typeof window.plausible === 'function') {
                try {
                    window.plausible(eventName, { props });
                    console.log(`Event sent to Plausible: ${eventName}`, props);
                } catch (error) {
                    console.error(`Error sending ${eventName} event to Plausible:`, error);
                }
            } else {
                console.warn(`Plausible not available for logging ${eventName} event. Queuing event.`);
                queueEvent(eventName, props);
            }
        }

        function logClick(product) {
            // בדיקה שהאובייקט product קיים ומכיל את השדה site
            if (!product || typeof product.site === 'undefined') {
                console.warn('Product data is incomplete:', product);
                return;
            }

            const clickData = {
                productName: product.name || 'unknown',
                targetSite: product.site || 'unknown',
                productPrice: product.price || 'unknown',
                searchQuery: currentSearchQuery || 'unknown',
                timestamp: new Date().toISOString()
            };

            console.log('Logging click:', clickData);

            if (window.plausible) {
                try {
                    window.plausible('ProductClick', {
                        props: {
                            productName: clickData.productName,
                            targetSite: clickData.targetSite,
                            productPrice: clickData.productPrice,
                            searchQuery: clickData.searchQuery
                        }
                    });
                } catch (error) {
                    console.error('Error sending data to Plausible:', error);
                }
            } else {
                console.warn('Plausible is not available');
            }

            let clicks = JSON.parse(localStorage.getItem('productClicks') || '[]');
            clicks.push(clickData);
            localStorage.setItem('productClicks', JSON.stringify(clicks));
        }

        function sortResults() {
            const sortType = document.getElementById('sort-select').value;
            let sortedResults = [...currentResults];

            if (sortType === 'price-asc' || sortType === 'price-desc') {
                sortedResults.sort((a, b) => {
                    const priceA = parseFloat(a.price.replace(/[^\d.]/g, ''));
                    const priceB = parseFloat(b.price.replace(/[^\d.]/g, ''));

                    if (isNaN(priceA)) return 1;
                    if (isNaN(priceB)) return -1;

                    return sortType === 'price-asc' ? priceA - priceB : priceB - priceA;
                });
            }
            sendPlausibleEvent('SortResults', { sortType });

            displaySearchResults(sortedResults);
        }

        function fetchProductImage(productUrl, imageContainer) {
            log(`Attempting to fetch image for product: ${productUrl}`);
            if (imageCache.has(productUrl)) {
                log(`Image found in cache for ${productUrl}`);
                displayImage(imageCache.get(productUrl), imageContainer);
                return;
            }

            const directImageUrl = buildDirectImageUrl(productUrl);
            if (directImageUrl) {
                tryLoadingDirectImage(directImageUrl, productUrl, imageContainer);
                return;
            }

            fetch(productUrl)
                .then(response => {
                    log(`Received response from ${productUrl}. Status: ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    log(`Successfully fetched HTML for ${productUrl}`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    findAndLoadImage(doc, productUrl, imageContainer);
                })
                .catch(error => {
                    log(`Error fetching product page ${productUrl}: ${error}`);
                    console.error('Error fetching product page:', error);
                    imageContainer.style.display = 'none';
                });
        }

        function buildDirectImageUrl(productUrl) {
            if (productUrl.includes('zap.co.il')) {
                const sku = productUrl.match(/(\d+)$/)?.[1];
                if (sku) return `https://img.zap.co.il/pics/new/${sku}.gif`;
            }
            if (productUrl.includes('ksp.co.il')) {
                const sku = productUrl.match(/item\/(\d+)/)?.[1];
                if (sku) return `https://img.ksp.co.il/item/${sku}/b_1.jpg`;
            }
            return null;
        }

        function tryLoadingDirectImage(imageUrl, productUrl, imageContainer) {
            const img = new Image();
            img.onload = () => {
                log(`Direct image successfully loaded: ${imageUrl}`);
                imageCache.set(productUrl, imageUrl);
                displayImage(imageUrl, imageContainer);
            };
            img.onerror = () => {
                log(`Failed to load direct image: ${imageUrl}. Falling back to HTML parsing.`);
                fetch(productUrl)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        findAndLoadImage(doc, productUrl, imageContainer);
                    })
                    .catch(error => {
                        log(`Error fetching product page ${productUrl}: ${error}`);
                        imageContainer.style.display = 'none';
                    });
            };
            img.src = imageUrl;
        }

        function findAndLoadImage(doc, baseUrl, imageContainer) {
            log(`Searching for image in document from ${baseUrl}`);
            const imageFinders = [
                // ... (כל שיטות החיפוש הקודמות נשארות ללא שינוי)
            ];

            tryNextImage(imageFinders, 0, baseUrl, imageContainer);
        }

        function tryNextImage(finders, index, baseUrl, imageContainer) {
            if (index >= finders.length) {
                log(`All image finding methods exhausted for ${baseUrl}. No image found.`);
                imageContainer.style.display = 'none';
                return;
            }

            log(`Trying image finder method ${index + 1} for ${baseUrl}`);
            let imageUrl = finders[index]();

            if (imageUrl) {
                log(`Image URL found: ${imageUrl}`);
                if (imageUrl.startsWith('/')) {
                    const urlObj = new URL(baseUrl);
                    imageUrl = `${urlObj.protocol}//${urlObj.hostname}${imageUrl}`;
                    log(`Relative URL converted to absolute: ${imageUrl}`);
                } else if (!imageUrl.startsWith('http')) {
                    imageUrl = new URL(imageUrl, baseUrl).href;
                    log(`Relative URL converted to absolute: ${imageUrl}`);
                }

                const img = new Image();
                img.onload = () => {
                    log(`Image successfully loaded: ${imageUrl}`);
                    imageCache.set(baseUrl, imageUrl);
                    displayImage(imageUrl, imageContainer);
                };
                img.onerror = () => {
                    log(`Failed to load image: ${imageUrl}`);
                    tryNextImage(finders, index + 1, baseUrl, imageContainer);
                };
                img.src = imageUrl;
            } else {
                log(`No image URL found with method ${index + 1}. Trying next method.`);
                tryNextImage(finders, index + 1, baseUrl, imageContainer);
            }
        }

        function displayImage(imageUrl, container) {
            container.style.display = 'flex';
            container.innerHTML = '';
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'תמונת מוצר';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            container.appendChild(img);
        }

        // ביצוע חיפוש מיידי אם יש פרמטר query ב-URL
        const urlParams = new URLSearchParams(window.location.search);
        const queryParam = urlParams.get('query');
        const priceParam = urlParams.get('price');
        const urlParam = urlParams.get('url');

        if (queryParam) {
            search(queryParam).then(() => {
                displayLogs();
            }).catch(error => {
                console.error('Initial search failed:', error);
                displayLogs();
            });
        }
    </script>
</body>

</html>