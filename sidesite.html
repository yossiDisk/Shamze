<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>תוצאות חיפוש</title>

  <script>
    // ===== GA GLOBAL =====
    const GA_MEASUREMENT_ID = 'G-PK1VZL0FDV';
    const GA_API_SECRET = '18bejCGgSeqXmtcUnvPoIQ';
    const DEBUG = false;

    const getClientId = () => {
      const existing = localStorage.getItem("client_id");
      if (existing) return existing;
      const newId = self.crypto.randomUUID();
      localStorage.setItem("client_id", newId);
      return newId;
    };

    const sendGAEvent = async (eventName, params = {}) => {
      const endpoint = DEBUG
        ? 'https://www.google-analytics.com/debug/mp/collect'
        : 'https://www.google-analytics.com/mp/collect';

      const body = {
        client_id: getClientId(),
        events: [{
          name: eventName,
          params: {
            engagement_time_msec: 100,
            page_title: document.title,
            page_location: location.href,
            ...params
          }
        }]
      };

      try {
        const res = await fetch(`${endpoint}?measurement_id=${GA_MEASUREMENT_ID}&api_secret=${GA_API_SECRET}`, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        const result = DEBUG ? await res.json() : await res.text();
        console.log("📤 GA Event sent:", eventName, params);
        if (DEBUG) console.log("📤 GA Response:", result);
      } catch (err) {
        console.error("❌ Failed to send GA event:", err);
      }
    };

    // page_view עם פרמטרים מה-URL (לא קריטי לפיצ'ר)
    (async () => {
      const urlParamsInit = new URLSearchParams(window.location.search);
      const eventName = urlParamsInit.get('event') || 'page_view';
      const eventParams = {};
      for (const [key, value] of urlParamsInit.entries()) {
        if (key !== 'event') eventParams[key] = isNaN(value) ? value : Number(value);
      }
      sendGAEvent(eventName, eventParams);
    })();
  </script>

  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background-color:#f0f0f0}
    .add-to-list-button{display:none!important}
    /* #googleAuthContainer{display:none!important} */
    .feature-message{display:none!important}
    .action-buttons{display:none!important}
    .search-results{display:flex;flex-direction:column;gap:15px}
    .product{border:1px solid #ddd;padding:15px;display:flex;align-items:center;background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);transition:all .3s ease;cursor:pointer}
    .product:hover{transform:translateY(-5px);box-shadow:0 4px 8px rgba(0,0,0,.2)}
    .product-image{width:120px;height:120px;margin-right:20px;display:flex;justify-content:center;align-items:center;background-color:#f8f8f8;border-radius:4px;overflow:hidden}
    .product-image img{max-width:100%;max-height:100%;object-fit:contain}
    .product-info{flex-grow:1}
    .product-info h3{margin-top:0;color:#333}
    .product-info p{margin:5px 0;color:#666}
    .product-info a{color:#1a73e8;text-decoration:none}
    .product-info a:hover{text-decoration:underline}
    .loading-container{text-align:center;margin:20px 0}
    .loading-spinner{border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:10px auto}
    .show-more-button{display:block;margin:20px auto;padding:10px 20px;background-color:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition:background-color .3s ease}
    .savings{margin-top:6px;font-size:13px;font-weight:500}
    .savings.good{color:#0c8b31}
    .savings.bad{color:#c62828}
    .savings.neutral{color:#777}
    .action-button{padding:10px 20px;background-color:#1a73e8;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;transition:background-color .3s ease;text-decoration:none}
    .product-header{border:1px solid #ddd;padding:15px;margin-bottom:15px;background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .product-header h2{margin:0 0 10px 0;color:#333;font-size:1.2em}
    .product-header p{margin:5px 0;color:#666}
    .action-button:hover,.show-more-button:hover{background-color:#1558b3}
    #copyMessage{position:fixed;top:20px;left:50%;transform:translateX(-50%);background-color:#4CAF50;color:#fff;padding:15px;border-radius:5px;display:none;z-index:1000}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sort-container{margin-bottom:20px}
    .sort-section select{padding:6px 8px;border:1px solid #ddd;border-radius:6px;background-color:#fff;font-size:13px;color:#333;cursor:pointer;outline:none;transition:border-color .3s ease,box-shadow .3s ease;min-width:120px;flex-shrink:0}
    .sort-section select:hover{border-color:#1a73e8}
    .sort-section select:focus{border-color:#1a73e8;box-shadow:0 0 0 2px rgba(26,115,232,.1)}
    .toggle-switch{position:relative;display:inline-block;width:44px;height:22px;flex-shrink:0}
    .toggle-switch input{opacity:0;width:0;height:0}
    .selected-product-box{display:flex;align-items:center;gap:15px;background-color:#f8f9fa;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.05);margin-bottom:10px}
    .selected-product-box .product-image{width:80px;height:80px;background-color:#fff;border:1px solid #ccc;border-radius:4px;overflow:hidden;display:flex;justify-content:center;align-items:center}
    .selected-product-box .product-image img{max-width:100%;max-height:100%;object-fit:contain}
    .loading-section{text-align:center;padding:30px;color:#444;font-size:15px}
    .back-button{margin-top:10px;padding:6px 12px;font-size:13px;background-color:#e8f0fe;border:1px solid #a2c6ff;border-radius:5px;cursor:pointer;color:#1a73e8;transition:background-color .3s}
    .back-button:hover{background-color:#d2e3fc}
    .offer-card{border:1px solid #d6d6d6;border-radius:8px;padding:14px 16px;margin-bottom:12px;background-color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06);cursor:pointer;transition:all .25s ease}
    .offer-card:hover{background-color:#f5faff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .offer-details{display:flex;justify-content:space-between;align-items:center;font-size:15px;color:#333;font-weight:500}
    .promo-tag{margin-top:6px;font-size:12px;display:inline-block;background-color:#ff9800;color:#fff;padding:2px 6px;border-radius:4px;font-weight:600}
    .product-header-callout{background-color:#f0f8ff;border:1px solid #c6dafc;border-radius:8px;padding:14px;margin-bottom:16px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .product-header-callout .instruction{font-size:15px;margin-bottom:6px;color:#1a73e8;font-weight:500}
    .product-header-callout .product-summary{font-size:16px;color:#333}
    .product-header-callout .product-summary .price{margin-right:10px;color:#555;font-weight:normal;font-size:15px}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.3s;border-radius:22px}
    .slider:before{position:absolute;content:"";height:16px;width:16px;left:3px;bottom:3px;background-color:#fff;transition:.3s;border-radius:50%}
    input:checked+.slider{background-color:#1a73e8}
    input:checked+.slider:before{transform:translateX(22px)}
    .toggle-label{font-size:13px;color:#333;user-select:none;font-weight:500;white-space:nowrap}
    .original-price-banner{text-align:center;padding:10px;margin-bottom:10px;background-color:#f1f1f1;border-radius:6px;font-size:14px;color:#333;font-weight:bold}
    .cheapest-tag{margin-top:6px;display:inline-block;background-color:#0c8b31;color:#fff;padding:2px 8px;font-size:13px;border-radius:6px;font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .highlight-offer{border:2px solid #0c8b31;background-color:#e6f4ea;box-shadow:0 2px 6px rgba(0,128,0,.1)}
    .help-icon{background:none;border:none;cursor:pointer;color:#666;padding:2px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:color .3s ease,background-color .3s ease;width:20px;height:20px;flex-shrink:0}
    .help-icon svg{width:14px;height:14px}
    .help-icon:hover{color:#1a73e8;background-color:rgba(26,115,232,.1)}
    .info-message{position:absolute;top:100%;right:0;left:0;background-color:#333;color:#fff;border-radius:6px;margin-top:10px;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.15);animation:slideDown .3s ease}
    .info-content{padding:12px;position:relative;font-size:12px;line-height:1.4}
    .close-info{position:absolute;top:6px;left:6px;background:none;border:none;color:#fff;cursor:pointer;font-size:16px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background-color .3s ease}
    .close-info:hover{background-color:rgba(255,255,255,.1)}
    .sort-container{position:relative;margin-bottom:20px}
    .sort-container>div{align-items:center}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:500px){
      .sort-container>div{gap:8px;flex-wrap:nowrap}
      .sort-section select{min-width:100px;font-size:12px;padding:5px 6px}
      .toggle-label{font-size:12px}
      .advanced-search-container{gap:4px}
      .help-icon{width:18px;height:18px}
      .help-icon svg{width:12px;height:12px}
    }
    @media (max-width:350px){
      .sort-container>div{gap:6px}
      .sort-section select{min-width:80px;font-size:11px;padding:4px 5px}
      .toggle-label{font-size:11px}
      .toggle-switch{width:38px;height:20px}
      .slider:before{height:14px;width:14px;left:3px;bottom:3px}
      input:checked+.slider:before{transform:translateX(18px)}
      .advanced-search-container{gap:3px}
    }

    /* ===== UI שלדים + CTA לטשטוש ===== */
    .results-skeleton{position:relative}
    .results-skeleton.blur .product{filter:blur(3px);pointer-events:none}
    .skeleton-product{
      border:1px solid #ddd;padding:15px;display:flex;align-items:center;
      background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.08);margin-bottom:12px
    }
    .skeleton-thumb,.skeleton-line{background:#eee;border-radius:6px}
    .skeleton-thumb{width:120px;height:120px;margin-right:20px}
    .skeleton-text{flex:1}
    .skeleton-line{height:16px;margin:8px 0;width:60%}
    .skeleton-line.small{width:35%}
    .overlay-continue{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.8);backdrop-filter:blur(2px);border-radius:8px
    }
    .overlay-card{
      background:#fff;border:1px solid #d6d6d6;border-radius:10px;padding:16px 18px;
      box-shadow:0 8px 24px rgba(0,0,0,.12);text-align:center;max-width:360px
    }
    .overlay-card h4{margin:0 0 8px;color:#333}
    .overlay-card p{margin:0 0 14px;color:#666;font-size:14px}
    .overlay-btn{
      display:inline-block;padding:10px 16px;background:#1a73e8;color:#fff;border:none;
      border-radius:6px;cursor:pointer;font-size:15px
    }
    .overlay-btn:hover{background:#1558b3}

    /* חיזוק קטן לעיצוב כותרת המוצר */
    .product-header{position:relative;padding:10px 10px 15px}
  </style>
</head>

<body>
  <div id="productHeader" class="product-header"></div>

  <div class="sort-container">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:nowrap;gap:10px;min-height:32px;">
      <div class="sort-section">
        <select id="sort-select" onchange="sortResults()">
          <option value="default">מיון לפי</option>
          <option value="price-asc">מחיר - מהנמוך לגבוה</option>
          <option value="price-desc">מחיר - מהגבוה לנמוך</option>
        </select>
      </div>
    </div>
  </div>

  <div id="loadingContainer" class="loading-container" style="display:none;">
    <div class="loading-spinner"></div>
    <p>אוספים מוצרים מכל האתרים, זה יכול לקחת עד <span id="countdown">10</span> שניות...</p>
  </div>

  <div id="searchResults" class="search-results"></div>

  <script>
    // ===== מונה טעינות אוטומטיות ללא קליק =====
    const AUTOLOADS_KEY = 'autoloads_without_click';
    const AUTOLOADS_LIMIT = 5;
    function getAutoloadsCount(){ return parseInt(localStorage.getItem(AUTOLOADS_KEY) || '0', 10); }
    function setAutoloadsCount(n){ localStorage.setItem(AUTOLOADS_KEY, String(n)); }
    function incAutoloadsCount(){ setAutoloadsCount(getAutoloadsCount()+1); }
    function resetAutoloads(){ setAutoloadsCount(0); }
    function shouldAutoSearch(){ return getAutoloadsCount() < AUTOLOADS_LIMIT; }

    // ===== קאש חיפושים (LRU עד 5) =====
    const SEARCH_CACHE_KEY = 'search_results_cache_v1';
    const SEARCH_CACHE_LIMIT = 5;

    function loadCache(){
      try { return JSON.parse(localStorage.getItem(SEARCH_CACHE_KEY) || '[]'); }
      catch { return []; }
    }
    function saveCache(entries){
      localStorage.setItem(SEARCH_CACHE_KEY, JSON.stringify(entries.slice(0, SEARCH_CACHE_LIMIT)));
    }
    function normalizeQuery(q){ return (q||'').trim().toLowerCase(); }
    function cleanPriceString(priceStr){ if(!priceStr) return null; return parseFloat(priceStr.replace(/[^\d.]/g,'')); }
    function buildSearchKey(query){
      const q = normalizeQuery(query);
      const p = cleanPriceString(getUrlParameter('price')) || 0;
      return `${q}__${p}`;
    }
    function getFromCache(key){
      const entries = loadCache();
      const idx = entries.findIndex(e => e.key === key);
      if (idx > -1){
        const hit = entries[idx];
        // עדכון סדר LRU – מקדמים לראש
        entries.splice(idx,1);
        entries.unshift(hit);
        saveCache(entries);
        return hit.results;
      }
      return null;
    }
    function putInCache(key, results){
      const entries = loadCache();
      const existIdx = entries.findIndex(e => e.key === key);
      if (existIdx > -1) entries.splice(existIdx,1);
      entries.unshift({ key, results, ts: Date.now() });
      if (entries.length > SEARCH_CACHE_LIMIT) entries.length = SEARCH_CACHE_LIMIT;
      saveCache(entries);
    }

    // ===== Utilities =====
    function extractDomainFromUrl(url){ try{ return new URL(url).hostname.replace('www.',''); }catch(e){ return url; } }
    function cleanDisplayPrice(priceStr){
      if(!priceStr) return null;
      const cleanPrice = priceStr.replace(/[₪]/g,'').trim();
      const numPrice = parseFloat(cleanPrice.replace(/,/g,''));
      return (!numPrice || isNaN(numPrice)) ? null : cleanPrice;
    }
    function formatPrice(price){
      if(!price) return '';
      const s = String(price).trim();
      if (s.includes('₪') || s.includes('ש"ח') || s.includes('שח')) return s;
      if (/^[\d,.\s]+$/.test(s)) return `₪${s}`;
      return `₪${s}`;
    }

    function displayProductHeader(){
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('query');
      const price = urlParams.get('price');
      const headerDiv = document.getElementById('productHeader');
      if(!headerDiv) return;

      const cleanPrice = cleanDisplayPrice(price);
      const priceText = cleanPrice ? `• מחיר: ₪${cleanPrice}` : '';

      headerDiv.innerHTML = `
        <div class="product-header-callout">
          <p class="instruction">בחר את התוצאה המתאימה ביותר</p>
          <div class="product-summary">
            <strong>${query || 'מוצר לא ידוע'}</strong>
            ${priceText ? `<span class="price">${priceText}</span>` : ''}
          </div>
        </div>
      `;
    }

    // ===== Login / Google token (כמו אצלך) =====
    let currentUser = null;

    function renderGoogleSignIn(container){
      container.innerHTML='';
      const buttonContainer=document.createElement('div');
      buttonContainer.className='auth-button-container';
      buttonContainer.style.cssText=`position:relative;overflow:hidden;height:40px;min-width:40px;transition:min-width .3s ease;z-index:1000;`;
      const button=document.createElement('button');
      button.className='auth-button';
      button.style.cssText=`width:auto;height:40px;padding:0;background:white;border:1px solid #dadce0;border-radius:20px;cursor:pointer;display:flex;align-items:center;white-space:nowrap;position:absolute;right:0;transition:all .3s ease;`;
      const text=document.createElement('span');
      text.textContent='התחבר עם Google';
      text.style.cssText=`padding:0 16px 0 10px;font-size:14px;color:#3c4043;opacity:0;transition:opacity .3s ease;`;
      button.appendChild(text);
      buttonContainer.addEventListener('mouseenter',()=>{buttonContainer.style.minWidth='180px';text.style.opacity='1';const t=document.querySelector('.add-list-text');if(t) t.style.display='none';});
      buttonContainer.addEventListener('mouseleave',()=>{buttonContainer.style.minWidth='40px';text.style.opacity='0';const t=document.querySelector('.add-list-text');if(t) t.style.display='block';});
      buttonContainer.appendChild(button);
      container.appendChild(buttonContainer);
    }

    function saveToken(token){
      localStorage.setItem('googleToken', token);
      window.parent.postMessage({type:'SAVE_TOKEN', token}, '*');
    }

    function checkLoginStatus(){
      return new Promise((resolve)=>{
        if (typeof chrome!=='undefined' && chrome.storage){
          chrome.storage.local.get(['googleToken'], (result)=>{
            handleToken(result.googleToken || localStorage.getItem('googleToken'), resolve);
          });
        } else {
          handleToken(localStorage.getItem('googleToken'), resolve);
        }
      });
    }

    function handleToken(token, resolve){
      const container=document.getElementById('googleAuthContainer');
      if (token){
        try{
          const payload=JSON.parse(atob(token.split('.')[1]));
          if (payload.exp*1000 > Date.now()){
            currentUser={ email:payload.email, name:payload.name, userId:payload.sub };
            if (container) renderShoppingListButton(container);
            resolve(true);
            return;
          }
        }catch(e){ console.error('Error parsing token:', e); }
      }
      if (container) renderGoogleSignIn(container);
      resolve(false);
    }

    function renderShoppingListButton(container){
      container.innerHTML='';
      const buttonContainer=document.createElement('div');
      buttonContainer.className='auth-button-container';
      buttonContainer.style.cssText=`position:relative;overflow:hidden;height:40px;min-width:40px;transition:min-width .3s ease;z-index:1000;`;
      const button=document.createElement('button');
      button.className='auth-button';
      button.style.cssText=`width:auto;height:40px;padding:0;background:#1a73e8;border:none;border-radius:20px;cursor:pointer;display:flex;align-items:center;white-space:nowrap;position:absolute;right:0;color:#fff;transition:all .3s ease;`;
      const iconContainer=document.createElement('div');
      iconContainer.style.cssText=`width:38px;height:38px;display:flex;align-items:center;justify-content:center;`;
      iconContainer.innerHTML=`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"/></svg>`;
      const text=document.createElement('span');
      text.textContent='רשימת הקניות שלי';
      text.style.cssText=`padding:0 16px 0 10px;font-size:14px;opacity:0;transition:opacity .3s ease;`;
      button.appendChild(iconContainer);button.appendChild(text);buttonContainer.appendChild(button);
      buttonContainer.addEventListener('mouseenter',()=>{buttonContainer.style.minWidth='180px';text.style.opacity='1';const t=document.querySelector('.add-list-text');if(t) t.style.display='none';});
      buttonContainer.addEventListener('mouseleave',()=>{buttonContainer.style.minWidth='40px';text.style.opacity='0';const t=document.querySelector('.add-list-text');if(t) t.style.display='block';});
      button.onclick=()=>{ window.open(getShoppingListPath(), '_blank'); };
      container.appendChild(buttonContainer);
    }

    function getShoppingListPath(){
      if (['localhost','127.0.0.1'].includes(window.location.hostname)) return '/shopping-list.html';
      return '/Shamze/shopping-list.html';
    }

    // ===== לוג חיפוש/טעינה =====
    const imageCache=new Map();
    let logMessages=[]; let currentResults=[]; let currentSearchQuery='';
    function log(m){ console.log(m); logMessages.push(m); }
    function displayLogs(){ console.log("--- Full Log ---"); console.log(logMessages.join('\n')); console.log("--- End Log ---"); }
    function showLoadingSpinner(){ document.getElementById('loadingContainer').style.display='block'; }
    function hideLoadingSpinner(){ document.getElementById('loadingContainer').style.display='none'; }

    let countdownIntervalId=null;
    function startCountdown(){
      let countdown=10;
      const el=document.getElementById('countdown');
      if (!el) return;
      if (countdownIntervalId) clearInterval(countdownIntervalId);
      countdownIntervalId=setInterval(()=>{
        countdown--; el.textContent=countdown;
        if (countdown<=0){ clearInterval(countdownIntervalId); countdownIntervalId=null; if (currentResults.length===0){ displayErrorMessage(`<p>נותן לזה עוד רגע...</p>`);} }
      },1000);
    }
    function stopCountdown(){ if (countdownIntervalId){ clearInterval(countdownIntervalId); countdownIntervalId=null; } }
    function displayErrorMessage(message){
      const container=document.getElementById('searchResults');
      if (container) container.innerHTML=message; else console.error("Search results container not found");
    }
    function showLoading(){ const c=document.getElementById('loadingContainer'); if (c){ c.style.display='block'; startCountdown(); } }
    function hideLoading(){ const c=document.getElementById('loadingContainer'); if (c) c.style.display='none'; }

    function getUrlParameter(name){ return new URLSearchParams(window.location.search).get(name); }

    // ===== UI שלדים מטושטשים + CTA =====
    function renderBlurredPreviewWithCTA(){
      const container=document.getElementById('searchResults');
      container.innerHTML='';
      const wrap=document.createElement('div');
      wrap.className='results-skeleton blur';
      for (let i=0;i<3;i++){
        const item=document.createElement('div');
        item.className='skeleton-product product';
        item.innerHTML=`
          <div class="skeleton-thumb"></div>
          <div class="skeleton-text">
            <div class="skeleton-line"></div>
            <div class="skeleton-line small"></div>
          </div>
        `;
        wrap.appendChild(item);
      }
      const overlay=document.createElement('div');
      overlay.className='overlay-continue';
      overlay.innerHTML=`
        <div class="overlay-card">
          <h4>רוצה להמשיך את ההשוואה?</h4>
          <p>לחיצה תטען תוצאות מעודכנות ותאפס את המונה.</p>
          <button id="continueCompareBtn" class="overlay-btn">המשך השוואה</button>
        </div>
      `;
      wrap.appendChild(overlay);
      container.appendChild(wrap);

      document.getElementById('continueCompareBtn').onclick=()=>{
        resetAutoloads();
        const qp = new URLSearchParams(window.location.search).get('query');
        if (qp) search(qp);
      };
    }

    // ===== חיפוש עם קאש =====
    function search(query){
      currentSearchQuery=query;
      const key = buildSearchKey(query);

      // בדיקת קאש לפני קריאת API
      const cached = getFromCache(key);
      if (cached && Array.isArray(cached)){
        console.log('⚡ Cache hit for', key);
        sendGAEvent('search_cache_hit', { search_key: key, results_count: cached.length });
        currentResults = cached;
        displaySearchResults(cached);
        return Promise.resolve(); // דילוג על API
      }

      // אין בקאש – נמשיך רגיל
      console.log('🧭 Cache miss for', key);
      sendGAEvent('search_cache_miss', { search_key: key });

      showLoadingSpinner();
      log(`Starting search for query: ${query}`);
      return new Promise((resolve,reject)=>{
        fetchSearchResults(query, key)
          .then(()=>{ log('Search completed'); hideLoadingSpinner(); resolve(); })
          .catch(error=>{ log(`Error during search: ${error}`); hideLoadingSpinner(); reject(error); });
      });
    }

    function fetchSearchResults(query, keyForCache){
      showLoading();

      const priceParam=getUrlParameter('price');
      const referrerUrl=getUrlParameter('url');
      const cleanedPrice=cleanPriceString(priceParam);

      const isAdvancedSearchEnabled=getAdvancedSearchStatus();
      let apiUrl=`https://kufu51g8uk.execute-api.il-central-1.amazonaws.com/stag/search?query=${encodeURIComponent(query)}&items=10`;
      if (isAdvancedSearchEnabled) apiUrl+='&wideSearch=true';

      if (cleanedPrice && cleanedPrice>0){
        const minPrice=Math.max(1, cleanedPrice*0.3);
        const maxPrice=cleanedPrice*3;
        apiUrl+=`&minPrice=${minPrice.toFixed(2)}&maxPrice=${maxPrice.toFixed(2)}`;
        if (referrerUrl) apiUrl+=`&url=${encodeURIComponent(referrerUrl)}`;
      }

      return fetch(apiUrl,{method:'GET',mode:'cors',headers:{'Accept':'application/json'}})
        .then(response=>{
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data=>{
          stopCountdown();
          if (!Array.isArray(data)) throw new Error('Invalid response format: expected array');
          log(`Received ${data.length} search results`);
          currentResults=data;
          displaySearchResults(data);
          hideLoading();
          // שמירה לקאש (אחרי הצלחה)
          try { putInCache(keyForCache || buildSearchKey(query), data); } catch(e){ console.warn('Cache save failed', e); }
        })
        .catch(error=>{
          console.error('Search error details:', {error:error.message, query, apiUrl, timestamp:new Date().toISOString()});
          hideLoading();
          const retryButtonHtml = `
            <div class="error-container" style="text-align:center;padding:20px;">
              <p style="color:#666;">לא הצלחנו לטעון את התוצאות</p>
              <a id="retryButton" href="#" target="_blank" style="display:inline-block;margin:10px;padding:10px 20px;background-color:#1a73e8;color:#fff;text-decoration:none;border-radius:4px;">נסה שוב</a>
              <p style="color:#666;">עדיין לא עובד?</p>
              <a href="https://mail.google.com/mail/?view=cm&fs=1&to=shamzezolyoter@gmail.com&su=פידבק על תוצאות החיפוש&body=היי, נראה שיש תקלה בטעינת תוצאות החיפוש:" target="_blank" style="color:#1a73e8;">דווח על התקלה</a>
            </div>
          `;
          displayErrorMessage(retryButtonHtml);
          const retryButton=document.getElementById('retryButton');
          if (retryButton){
            retryButton.addEventListener('click',(e)=>{
              e.preventDefault();
              const retryUrl=`https://yossidisk.github.io/Shamze/cupons.html?source=side&search=true&query=${encodeURIComponent(currentSearchQuery||'')}`;
              window.open(retryUrl,'_blank');
            });
          }
        });
    }

    function sortResultsByClosestToPrice(results, referencePrice){
      if (!referencePrice || results.length===0) return results;
      const cleanedRef=parseFloat(referencePrice.replace(/[^\d.]/g,''));
      if (isNaN(cleanedRef)) return results;

      let belowRef=[], aboveRef=[];
      for (const product of results){
        const price=parseFloat(product.price.replace(/[^\d.]/g,''));
        if (isNaN(price)) continue;
        if (price<cleanedRef) belowRef.push({...product, numericPrice:price});
        else aboveRef.push({...product, numericPrice:price});
      }
      belowRef.sort((a,b)=>b.numericPrice-a.numericPrice);
      aboveRef.sort((a,b)=>a.numericPrice-b.numericPrice);
      return [...belowRef, ...aboveRef];
    }

    function calculateSimilarity(a,b){
      a=a.toLowerCase().trim(); b=b.toLowerCase().trim();
      if (a===b) return 100;
      if (a.includes(b) || b.includes(a)) return 90;
      const aWords=a.split(/\s+/), bWords=b.split(/\s+/);
      const common=aWords.filter(w=>bWords.includes(w));
      const score=(common.length/Math.max(aWords.length,bWords.length))*80;
      return Math.round(score);
    }

    function displaySearchResults(results){
      const container=document.getElementById('searchResults');
      container.innerHTML='';

      if (!results || results.length===0){
        const noResultsHtml = `
          <div class="error-container" style="text-align:center;padding:20px;">
            <p style="color:#666;">לא נמצאו תוצאות למוצר "${currentSearchQuery}"</p>
            <a id="retryButton" href="#" target="_blank" style="display:inline-block;margin:10px;padding:10px 20px;background-color:#1a73e8;color:#fff;text-decoration:none;border-radius:4px;">נסה בדרך אחרת</a>
            <p style="color:#666;">לא מוצא את מה שחיפשת?</p>
            <a href="https://mail.google.com/mail/?view=cm&fs=1&to=shamzezolyoter@gmail.com&su=משוב על חיפוש ללא תוצאות&body=היי, חיפשתי '${currentSearchQuery}' אבל לא קיבלתי תוצאות:" target="_blank" style="color:#1a73e8;">דווח לנו והצע שיפור</a>
          </div>
        `;
        displayErrorMessage(noResultsHtml);
        const retryButton=document.getElementById('retryButton');
        if (retryButton){
          retryButton.addEventListener('click',(e)=>{
            e.preventDefault();
            const retryUrl=`https://yossidisk.github.io/Shamze/cupons.html?source=side&search=true&query=${encodeURIComponent(currentSearchQuery)}`;
            window.open(retryUrl,'_blank');
          });
        }
        return;
      }

      const sortType=document.getElementById('sort-select')?.value;
      if (!sortType || sortType==='default'){
        const queryText=currentSearchQuery || getUrlParameter('query') || '';
        results.sort((a,b)=> calculateSimilarity(b.name||'',queryText) - calculateSimilarity(a.name||'',queryText));
      }

      const initialResults=results.slice(0,3);
      const remainingResults=results.slice(3);

      initialResults.forEach(product=>{
        const el=createProductElement(product);
        container.appendChild(el);
      });

      if (remainingResults.length>0){
        const btn=document.createElement('button');
        btn.textContent='עוד תוצאות';
        btn.className='show-more-button';
        btn.onclick=()=> showMoreResults(remainingResults);
        container.appendChild(btn);
      }
    }

    function createProductElement(product){
      const productDiv=document.createElement('div');
      productDiv.className='product';

      const imageHtml = product.image ? `<img src="${product.image}" alt="תמונת מוצר" style="max-width:100%;max-height:100%;object-fit:contain;" />` : '';

      const formattedPrice=formatPrice(product.price);
      productDiv.innerHTML=`
        <div class="product-image">${imageHtml}</div>
        <div class="product-info">
          <h3>${product.name}</h3>
          <p>מחיר משוער: ${formattedPrice}</p>
        </div>
      `;

      productDiv.onclick=()=>{ logClick(product); handleProductClick(product); };

      if (!product.image){
        fetchAndDisplayProductImage(product.url, productDiv.querySelector('.product-image'));
      }
      return productDiv;
    }

    async function handleProductClick(product){
      const topContainer=document.getElementById('productHeader');
      const resultsContainer=document.getElementById('searchResults');
      const originalResults=[...currentResults];

      resultsContainer.style.opacity='0.3';
      topContainer.innerHTML='';
      resultsContainer.innerHTML=`
        <div class="loading-section">
          <div class="loading-spinner"></div>
          <p style="text-align:center;">מחפש הצעות נוספות עבורך...</p>
        </div>
      `;

      const priceFromUrl=getUrlParameter('price');
      const numericPrice=parseFloat((priceFromUrl||'').replace(/[^\d.]/g,'')) || 0;

      topContainer.innerHTML=`
        <div class="selected-product-box">
          <div class="product-image"><img src="${product.image||''}" alt="" /></div>
          <div class="product-info">
            <h3>${product.name}</h3>
            <p>מחיר מקורי: ₪${numericPrice.toFixed(2)}</p>
            <button id="backToResultsBtn" class="back-button">← חזרה לתוצאות</button>
          </div>
        </div>
      `;
      document.getElementById('backToResultsBtn').onclick=()=>{
        displaySearchResults(originalResults);
        topContainer.innerHTML='';
      };

      const apiUrl=`https://vpfi5d6dw9.execute-api.il-central-1.amazonaws.com/default/getDirectShoppingLink`
        + `?product_id=${encodeURIComponent(product.LinkParams?.value||'')}`
        + `&expectedPrice=${encodeURIComponent(numericPrice)}`
        + `&expectedMerchant=${encodeURIComponent(product.site||'')}`
        + `&list=true`;

      try{
        const res=await fetch(apiUrl);
        const data=await res.json();
        if (data.status!=='ok' || !data.offers || data.offers.length===0){
          resultsContainer.innerHTML='<p style="text-align:center;">לא נמצאו הצעות נוספות.</p>';
          return;
        }
        setTimeout(()=>{resultsContainer.style.opacity='1';},200);
        resultsContainer.innerHTML='';
        data.offers.sort((a,b)=>a.price-b.price);
        const minPrice=data.offers[0]?.price || 0;
        const hasCheaper = data.offers.some(o=>o.price<numericPrice);
        const shouldHighlightCheapest = data.offers.length>1 && hasCheaper;

        data.offers.forEach((offer)=>{
          const offerCard=document.createElement('div');
          const priceDiff = numericPrice - offer.price;
          const isCheapest = shouldHighlightCheapest && offer.price===minPrice;
          const savingsText = priceDiff>0
            ? `<div class="savings good">חיסכון של ₪${priceDiff.toFixed(2)}</div>`
            : priceDiff<0
              ? `<div class="savings bad">יקר ב־₪${Math.abs(priceDiff).toFixed(2)}</div>`
              : `<div class="savings neutral">אותו מחיר</div>`;

          offerCard.className = `offer-card ${isCheapest ? 'highlight-offer' : ''}`;
          offerCard.innerHTML=`
            <div class="offer-details">
              <span class="merchant">${offer.merchant}</span>
              <span class="price">₪${offer.price.toFixed(2)}</span>
            </div>
            ${isCheapest ? `<div class="cheapest-tag">🔥 הכי זול!</div>` : ''}
            ${savingsText}
          `;

          offerCard.onclick=()=>{
            const base_domain = (()=>{ try{ return new URL(offer.link).hostname.replace(/^www\./,''); }catch{ return extractDomainFromUrl(offer.link).replace(/^www\./,''); } })();
            sendGAEvent('offer_select',{
              event_category:'offers_list',
              event_label:`${offer.merchant}_${product.name||'unknown'}`,
              product_name:product.name||'unknown',
              product_site:product.site||'unknown',
              search_query:currentSearchQuery || (new URLSearchParams(window.location.search).get('query')) || 'unknown',
              reference_price:isNaN(numericPrice)?'none':numericPrice,
              offer_merchant:offer.merchant,
              offer_price:offer.price,
              selected_is_cheapest:!!isCheapest,
              target_url:offer.link,
              base_domain
            });
            const w=window.open(offer.link,'_blank');
            if (w) w.opener=null;
          };
          resultsContainer.appendChild(offerCard);
        });
      }catch(err){
        console.error('API Error:', err);
        resultsContainer.innerHTML='<p style="text-align:center;">אירעה שגיאה בטעינת ההצעות.</p>';
      }
    }

    function showMoreResults(remainingResults){
      const container=document.getElementById('searchResults');
      const btn=container.querySelector('.show-more-button');
      remainingResults.forEach(product=>{
        const el=createProductElement(product);
        container.insertBefore(el, btn);
      });
      btn.remove();
    }

    // איפוס מונה בעת קליק על מוצר
    function logClick(product){
      if (!product){ console.warn('Product data is missing'); return; }

      // איפוס המונה – קליק אמיתי
      resetAutoloads();

      const urlParams=new URLSearchParams(window.location.search);
      const clickData={
        searchParams:{
          query:urlParams.get('query') || currentSearchQuery || 'unknown',
          referencePrice:urlParams.get('price') || 'none',
          referrerUrl:urlParams.get('url') || 'none',
          originalDomain:urlParams.get('url') ? new URL(urlParams.get('url')).hostname : 'unknown'
        },
        productInfo:{...product},
        productName:product.name||'unknown',
        productPrice:product.price||'unknown',
        numericPrice:parseFloat(String(product.price||'0').replace(/[^\d.]/g,'')) || 0,
        targetSite:product.site||'unknown',
        targetUrl:product.urlAff || product.url || 'unknown',
        timestamp:new Date().toISOString(),
        deviceInfo:{screenWidth:window.innerWidth, screenHeight:window.innerHeight, userAgent:navigator.userAgent}
      };

      sendGAEvent('product_click',{
        product_name:clickData.productName,
        product_site:clickData.targetSite,
        product_price:clickData.numericPrice,
        search_query:clickData.searchParams.query,
        reference_price:clickData.searchParams.referencePrice,
        original_site:clickData.searchParams.originalDomain,
        click_timestamp:clickData.timestamp,
        target_url:clickData.targetUrl,
        price_difference: clickData.searchParams.referencePrice!=='none'
          ? (clickData.numericPrice - parseFloat(clickData.searchParams.referencePrice.replace(/[^\d.]/g,'')||'0')).toFixed(2)
          : 'none',
        event_category:'search_results',
        event_label:`${clickData.targetSite}_${clickData.searchParams.query}`
      });

      try{
        let localClicks=JSON.parse(localStorage.getItem('productClicks')||'[]');
        if (localClicks.length>=50) localClicks=localClicks.slice(-49);
        localClicks.push(clickData);
        localStorage.setItem('productClicks', JSON.stringify(localClicks));
      }catch(e){ console.error('Error saving click locally:', e); }

      try{
        window.parent.postMessage({type:'PRODUCT_CLICK_FROM_IFRAME', data:clickData, timestamp:Date.now()}, '*');
      }catch(e){ console.error('Error sending message to parent window:', e); }

      return clickData;
    }

    function fetchAndDisplayProductImage(productUrl, imageContainer){
      if (!productUrl || !productUrl.startsWith('http')){ imageContainer.style.display='none'; return; }
      const directImageUrl = (()=> {
        const map={
          'zap.co.il': url => { const sku=url.match(/(\d+)$/)?.[1]; return sku ? `https://img.zap.co.il/pics/new/${sku}.gif` : null; },
          'ksp.co.il': url => { const sku=url.match(/item\/(\d+)/)?.[1]; return sku ? `https://img.ksp.co.il/item/${sku}/b_1.jpg` : null; }
        };
        for (const domain in map){ if (productUrl.includes(domain)) return map[domain](productUrl); }
        return null;
      })();

      if (!directImageUrl){ imageContainer.style.display='none'; return; }

      const img=new Image();
      img.onload=()=>{
        imageContainer.innerHTML='';
        img.alt='תמונת מוצר';
        img.style.maxWidth='100%';
        img.style.maxHeight='100%';
        img.loading='lazy';
        imageContainer.appendChild(img);
        imageContainer.style.display='flex';
      };
      img.onerror=()=> (imageContainer.style.display='none');
      img.src=directImageUrl;
    }

    // ===== Advanced Search state =====
    const ADVANCED_SEARCH_KEY='advancedSearchEnabled';
    const ADVANCED_SEARCH_TIMESTAMP_KEY='advancedSearchTimestamp';
    const ADVANCED_SEARCH_DURATION=20*60*1000;

    function initializeAdvancedSearch(){
      const checkbox=document.getElementById('advanced-search-toggle');
      if (checkbox) checkbox.checked=getAdvancedSearchStatus();
    }
    function getAdvancedSearchStatus(){
      try{
        const stored=localStorage.getItem(ADVANCED_SEARCH_KEY);
        if (stored===null){
          localStorage.setItem(ADVANCED_SEARCH_KEY,'true');
          localStorage.setItem(ADVANCED_SEARCH_TIMESTAMP_KEY, Date.now().toString());
          return true;
        }
        const enabled = stored==='true';
        const ts = parseInt(localStorage.getItem(ADVANCED_SEARCH_TIMESTAMP_KEY)||'0',10);
        const now=Date.now();
        if (enabled && (now - ts > ADVANCED_SEARCH_DURATION)){
          localStorage.removeItem(ADVANCED_SEARCH_KEY);
          localStorage.removeItem(ADVANCED_SEARCH_TIMESTAMP_KEY);
          const checkbox=document.getElementById('advanced-search-toggle');
          if (checkbox) checkbox.checked=false;
          return false;
        }
        return enabled;
      }catch(e){ console.error('Error reading advanced search status:', e); return false; }
    }
    function setAdvancedSearchStatus(enabled){
      try{
        if (enabled){
          localStorage.setItem(ADVANCED_SEARCH_KEY,'true');
          localStorage.setItem(ADVANCED_SEARCH_TIMESTAMP_KEY, Date.now().toString());
        }else{
          localStorage.removeItem(ADVANCED_SEARCH_KEY);
          localStorage.removeItem(ADVANCED_SEARCH_TIMESTAMP_KEY);
        }
      }catch(e){ console.error('Error saving advanced search status:', e); }
    }
    function toggleAdvancedSearch(){
      const checkbox=document.getElementById('advanced-search-toggle');
      const isEnabled=checkbox.checked;
      setAdvancedSearchStatus(isEnabled);
      if (typeof gtag==='function'){ gtag('event','toggle_advanced_search',{enabled:isEnabled, search_query:currentSearchQuery||'unknown'}); }
      if (currentSearchQuery) search(currentSearchQuery);
    }
    function showAdvancedSearchInfo(){
      const infoDiv=document.getElementById('advanced-search-info');
      if (infoDiv){
        infoDiv.style.display='block';
        if (typeof gtag==='function'){ gtag('event','click_advanced_search_help',{search_query:currentSearchQuery||'unknown'}); }
        setTimeout(()=> hideAdvancedSearchInfo(), 5000);
      }
    }
    function hideAdvancedSearchInfo(){
      const infoDiv=document.getElementById('advanced-search-info');
      if (infoDiv) infoDiv.style.display='none';
    }

    // ===== DOMContentLoaded אחד מאוחד =====
    const urlParams = new URLSearchParams(window.location.search);
    document.addEventListener('DOMContentLoaded', ()=>{
      displayProductHeader();
      initializeAdvancedSearch();
      checkLoginStatus();

      const queryParam = urlParams.get('query');
      if (queryParam){
        if (shouldAutoSearch()){
          incAutoloadsCount();          // נספר טעינה אוטומטית
          search(queryParam).catch(err=>console.error('Initial search failed:', err));
        } else {
          renderBlurredPreviewWithCTA();
        }
      }
    });
  </script>
</body>
</html>
