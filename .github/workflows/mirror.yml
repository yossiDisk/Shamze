name: Mirror to shamze-pages

on:
  push:
    branches: [ main ]

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false    # <— הוסף שורה זו


      - name: Mirror to target repo (with debug)
        env:
          TOKEN: ${{ secrets.MIRROR_TOKEN }}
        run: |
          set -x   # הדפס כל פקודה לפני ביצועה

          # Debug טוקן
          if [ -z "$TOKEN" ]; then
            echo "❌ MIRROR_TOKEN is empty!" >&2
            exit 1
          else
            echo "✅ MIRROR_TOKEN present (masked)"
          fi

          # קונפיגורציה
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # הסרת remote קיים (אם קיים) כדי למנוע duplicate
          git remote remove target || true

          # הוספת ה-remote החדש
          git remote add target https://$TOKEN@github.com/yossiDisk/shamze-pages.git

          # בדיקת קישור
          git remote get-url target | sed -e 's#//.*@#//<token>@#' -e 's#\.git#<…>.git#'
          echo -n "Trying git ls-remote… "
          git ls-remote target HEAD && echo "✅ ls-remote OK" || { echo "❌ ls-remote FAILED"; exit 1; }

          # הדחיפה בפועל
          git push --force target main:main
