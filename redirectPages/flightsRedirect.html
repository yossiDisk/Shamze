<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2FYGT228T0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2FYGT228T0');
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>בחירת נוסעים</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:2rem;background:#eef2f7;color:#212529;direction:rtl}
    header{text-align:center;margin-bottom:1rem;font-size:1.6rem;font-weight:700}
    #summary{max-width:460px;margin:0 auto 2rem;background:#fff;padding:1.2rem 1.7rem;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);font-size:1rem;line-height:1.7}
    form{max-width:460px;margin:0 auto;background:#fff;padding:2rem 2.2rem;border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,.08)}
    label{display:block;margin-top:1rem;font-weight:600}
    input[type=number]{width:100%;padding:.55rem;border:1px solid #ced4da;border-radius:8px;font-size:1rem}
    button{margin-top:2rem;width:100%;padding:.9rem;border:none;border-radius:8px;font-size:1.05rem;font-weight:700;cursor:pointer;background:#007bff;color:#fff;transition:background .25s}
    button:hover:not(:disabled){background:#0062d1}
    button:disabled{background:#6c757d;cursor:not-allowed}
    .error{color:#dc3545;font-size:.9rem;margin-top:.5px;min-height:1.2rem}
    /* overlay loader */
    #loader{position:fixed;inset:0;background:#ffffff;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;z-index:9999;gap:1.4rem}
    .sky{position:relative;width:100%;height:140px;overflow:hidden}
    .plane{position:absolute;font-size:3rem;animation:fly 6s linear infinite}
    .cloud{position:absolute;font-size:2.2rem;color:#b0c4de;opacity:.8;animation:cloud 14s linear infinite}
    @keyframes fly{0%{left:-10%;top:55%}100%{left:110%;top:40%}}
    @keyframes cloud{0%{left:110%}100%{left:-30%}}
    #loaderMain{font-weight:600;font-size:1.15rem}
    #loaderTip{font-size:.95rem;color:#555}
    /* progress bar */
    #progressWrap{width:70%;max-width:420px;height:8px;background:#e0e0e0;border-radius:5px;overflow:hidden;margin-top:.2rem}
    #progressBar{height:100%;width:0;background:#007bff;transition:width .25s linear}
  </style>
</head>
<body>
  <header id="routeHeader">טעינת מידע…</header>
  <div id="summary" hidden></div>
  <form id="passengerForm" novalidate>
    <label for="adults">מבוגרים (12+)</label>
    <input type="number" id="adults" name="adults" min="1" max="8" value="1" required />

    <label for="children">ילדים (2‑11)</label>
    <input type="number" id="children" name="children" min="0" max="8" value="0" required />

    <label for="infants">תינוקות (<2)</label>
    <input type="number" id="infants" name="infants" min="0" max="8" value="0" required />

    <div id="errorMsg" class="error" hidden></div>
    <button type="submit" id="submitBtn">המשך</button>
  </form>

  <!-- overlay loader -->
  <div id="loader">
     <div class="sky">
       <div class="plane">✈️</div>
       <div class="cloud" style="top:20%;animation-delay:0s">☁️</div>
       <div class="cloud" style="top:60%;font-size:3rem;animation-delay:4s">☁️</div>
       <div class="cloud" style="top:35%;font-size:2.6rem;animation-delay:8s">☁️</div>
     </div>
     <div id="loaderMain">מכינים עבורך את הדיל הטוב ביותר…</div>
     <div id="loaderTip">טיפ: תמיד כדאי לבדוק ביטוח נסיעות מראש! </div>
     <div id="progressWrap"><div id="progressBar"></div></div>
  </div>

  <script>
    (function(){
      const raw=window.location.href.match(/[?&]link=([^#]+)/);
      let flightUrl;try{flightUrl=new URL(decodeURIComponent(raw?raw[1]:''));}catch(e){flightUrl=new URL(window.location.href)}

      const fp=flightUrl.searchParams;
      const origin=fp.get('origin'),dest=fp.get('destination');
      const outD=fp.get('out_date'),inD=fp.get('in_date');
      const price=fp.get('price'),air=fp.get('deal_airline');

      const sum=document.getElementById('summary');
      if(origin&&dest){sum.innerHTML=`<strong>יעד:</strong> ${origin} → ${dest}<br>`+(outD?`<strong>תאריכים:</strong> ${outD} – ${inD}<br>`:'')+(air?`<strong>חברת תעופה:</strong> ${air}<br>`:'')+(price?`<strong>מחיר מדווח:</strong> ${price} $`:'');sum.hidden=false}
      document.getElementById('routeHeader').textContent=(origin&&dest&&outD&&inD)?`${origin} → ${dest} | ${outD} – ${inD}`:'נתוני טיסה חסרים';

      const f=document.getElementById('passengerForm');const eMsg=document.getElementById('errorMsg');const btn=document.getElementById('submitBtn');
      const ad=document.getElementById('adults'),ch=document.getElementById('children'),inf=document.getElementById('infants');
      const loader=document.getElementById('loader');const loadMain=document.getElementById('loaderMain');const loadTip=document.getElementById('loaderTip');
      const progress=document.getElementById('progressBar');

      [ad,ch,inf].forEach(el=>el.addEventListener('input',()=>{inf.max = Math.min(+ad.value, 8 - +ch.value);if(+inf.value>+inf.max)inf.value=inf.max;validate();}));
      function showErr(m){eMsg.textContent=m;eMsg.hidden=false;btn.disabled=true}
      function hideErr(){eMsg.hidden=true;btn.disabled=false}
      function validate(){
        const a=+ad.value,c=+ch.value,i=+inf.value,k=c+i;
        if(a<1||a>8)                 return showErr('מספר המבוגרים חייב להיות בין 1 ל‑8.');
        if(c>8)                      return showErr('לא ניתן לבחור יותר מ‑8 ילדים.');
        if(k>8)                      return showErr('המספר הכולל של ילדים ותינוקות לא יכול להיות מעל 8.');
        if(i>a)                      return showErr('מספר התינוקות חייב להיות בין 0 ובין מספר המבוגרים.');
        // הודעות גבול כדי שהמשתמש יבין למה אינו יכול להוסיף עוד
        if(c===8)                    return showErr('הגעת למקסימום 8 ילדים.');
        if(k===8)                    return showErr('הגעת למקסימום 8 בסך‑הכל (ילדים + תינוקות).');
        if(i===a)                    return showErr('מספר התינוקות לא יכול לחרוג ממספר המבוגרים.');
        hideErr();return true;
      }

      f.addEventListener('submit',ev=>{ev.preventDefault();if(!validate())return;const url=new URL(flightUrl);url.pathname=url.pathname.replace('redirect','redirect-page');url.searchParams.set('adults',ad.value);url.searchParams.set('children',ch.value);url.searchParams.set('infants',inf.value);startPreload(url.toString());});

      // messages & tips arrays
      const msgs=[`בודקים מבצעים ל‑${dest||'היעד שבחרת'}…`,`מעדכנים זמינות ${outD?'ל‑'+outD+'–'+inD:''}…`,`משווים תעריפים בין חברות תעופה…`,`מוצאים עבורך מושבים נוחים…`,`מאמתים מחירים בזמן אמת…`];
      const tips=[`טיפ: ארוז אוזניות נוחות לטיסה נעימה יותר`,`טיפ: בקש מושב מעבר אם אתה קם הרבה`,`טיפ: הורד סרטים לטלפון לפני ההמראה`,`טיפ: השתדל לשתות מים לפני הטיסה`,`טיפ: עטוף נוזלים בשקית אטומה לחסוך בלגן`];
      let idx=0,interval;
      const totalDuration=20000; // 20s wait
      function rotate(){loadMain.textContent=msgs[idx%msgs.length];loadTip.textContent=tips[idx%tips.length];idx++;}

      function startPreload(target){
        loader.style.display='flex';rotate();interval=setInterval(rotate,2500);
        progress.style.width='0';
        const start=Date.now();
        const progInt=setInterval(()=>{
          const pct=Math.min(100,((Date.now()-start)/totalDuration)*100);
          progress.style.width=pct+'%';
          if(pct>=100) clearInterval(progInt);
        },200);
        const iframe=document.createElement('iframe');iframe.style.width='0';iframe.style.height='0';iframe.style.border='0';document.body.appendChild(iframe);
        let first=true;iframe.onload=()=>{if(first){first=false;}else{clearInterval(interval);window.location.href=iframe.src;}};
        iframe.src=target;
        setTimeout(()=>{clearInterval(interval);window.location.href=target;},totalDuration);
      }

      validate();
    })();
  </script>
</body>
</html>
